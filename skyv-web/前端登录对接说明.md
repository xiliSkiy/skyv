# SkyEye 前端登录对接说明

## 概述

本文档说明前端登录界面与后端认证接口的对接情况，包括如何测试和使用登录功能。

## 已完成的对接工作

### 1. API接口更新
- ✅ 更新了 `src/api/auth.js`，与后端API接口对应
- ✅ 支持登录、登出、Token刷新、Token检查等接口
- ✅ 添加了测试接口用于验证功能

### 2. 认证工具更新
- ✅ 更新了 `src/utils/auth.js`，支持双Token机制
- ✅ 使用 localStorage 存储Token和用户信息
- ✅ 添加了Token解析和权限检查工具

### 3. 用户状态管理更新
- ✅ 更新了 `src/store/modules/user.js`，与后端响应格式对接
- ✅ 支持完整的用户信息存储和管理
- ✅ 添加了Token刷新机制

### 4. HTTP请求拦截器更新
- ✅ 更新了 `src/utils/request.js`，添加自动Token刷新
- ✅ 完善了错误处理和用户体验
- ✅ 支持请求队列管理

### 5. 测试页面
- ✅ 创建了 `src/views/auth/TestApi.vue` 测试页面
- ✅ 可以测试所有认证相关的API接口
- ✅ 实时显示用户状态和Token信息

## 如何测试

### 1. 启动后端服务

确保后端服务已启动（默认端口8080）：

```bash
cd skyv-server
mvn spring-boot:run
```

### 2. 启动前端服务

```bash
cd skyv-web
npm install
npm run dev
```

### 3. 访问测试页面

打开浏览器访问：`http://localhost:5173/test-api`

### 4. 测试步骤

1. **测试公开接口**：点击"测试公开接口"按钮，验证无需认证的接口
2. **登录测试**：
   - 默认管理员账号：`admin` / `admin123456`
   - 默认普通用户：`user` / `user123456`
   - 点击"测试登录"进行登录
3. **测试受保护接口**：登录成功后，测试需要认证的接口
4. **测试管理员接口**：使用管理员账号登录后测试
5. **Token刷新测试**：测试Token自动刷新功能
6. **登出测试**：测试登出功能

## 正常登录流程

### 1. 访问登录页面

访问：`http://localhost:5173/login`

### 2. 输入登录信息

- 用户名：`admin`
- 密码：`admin123456`
- 勾选"记住我"（可选）

### 3. 登录成功

- 系统会自动保存Token和用户信息
- 跳转到控制台页面
- 后续请求会自动携带Token

## API接口说明

### 登录接口
```javascript
POST /api/auth/login
{
  "username": "admin",
  "password": "admin123456",
  "rememberMe": false
}
```

### 响应格式
```javascript
{
  "code": 200,
  "message": "登录成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzI1NiJ9...",
    "refreshToken": "eyJhbGciOiJIUzI1NiJ9...",
    "tokenType": "Bearer",
    "expiresIn": 86400000,
    "userInfo": {
      "id": 1,
      "username": "admin",
      "realName": "系统管理员",
      "email": "admin@skyeye.com",
      "isAdmin": true,
      "roles": ["ADMIN"],
      "permissions": ["user:view", "device:create", ...]
    }
  }
}
```

## 前端状态管理

### 用户状态
```javascript
const userStore = useUserStore()

// 检查登录状态
userStore.isLoggedIn

// 获取用户信息
userStore.username
userStore.realName
userStore.isAdminUser

// 权限检查
userStore.hasPermission('device:create')
userStore.hasRole('ADMIN')
```

### Token管理
```javascript
import { getAccessToken, getRefreshToken } from '@/utils/auth'

// 获取Token
const accessToken = getAccessToken()
const refreshToken = getRefreshToken()
```

## 自动Token刷新

系统已实现自动Token刷新机制：

1. **请求拦截**：每个请求自动携带Token
2. **响应拦截**：检测401错误
3. **自动刷新**：使用refreshToken获取新的accessToken
4. **请求重试**：刷新成功后重新发送原请求
5. **失败处理**：刷新失败时跳转到登录页

## 权限控制

### 路由守卫
```javascript
// 需要认证的路由会自动检查Token
router.beforeEach((to, from, next) => {
  if (to.meta.requiresAuth !== false) {
    const token = getAccessToken()
    if (token) {
      next()
    } else {
      next({ path: '/login', query: { redirect: to.fullPath } })
    }
  }
})
```

### 组件级权限
```vue
<template>
  <!-- 只有管理员可见 -->
  <el-button v-if="userStore.isAdminUser">管理员功能</el-button>
  
  <!-- 有特定权限可见 -->
  <el-button v-if="userStore.hasPermission('device:create')">创建设备</el-button>
  
  <!-- 有特定角色可见 -->
  <el-button v-if="userStore.hasRole('DEVICE_MANAGER')">设备管理</el-button>
</template>
```

## 错误处理

### 常见错误码
- `401`: 未授权访问，Token无效或已过期
- `403`: 权限不足
- `608`: 登录失败，用户名或密码错误
- `609`: Token已过期
- `610`: Token无效

### 错误处理流程
1. **显示错误消息**：使用ElementPlus的Message组件
2. **自动重试**：Token过期时自动刷新
3. **跳转登录**：认证失败时跳转到登录页
4. **保存状态**：记录重定向路径，登录后自动跳转

## 开发调试

### 开启调试日志
在开发环境下，系统会自动打印API请求和响应日志：

```javascript
// 请求日志
🚀 API Request: POST /api/auth/login

// 响应日志  
✅ API Response: POST /api/auth/login
```

### 查看状态
- 打开浏览器开发者工具
- 查看Network面板的API请求
- 查看Application面板的localStorage存储
- 查看Console面板的日志输出

## 注意事项

1. **Token存储**：目前使用localStorage，生产环境建议考虑安全性
2. **CORS配置**：后端已配置CORS，支持跨域请求
3. **环境变量**：确保前端环境变量配置正确
4. **网络超时**：请求超时时间设置为10秒
5. **错误重试**：Token刷新失败会清除所有认证信息

## 生产环境部署

### 前端构建
```bash
npm run build
```

### 环境变量配置
```bash
# .env.production
VITE_APP_API_BASE_URL=https://your-api-domain.com
VITE_APP_TITLE=SkyEye智能监控系统
```

### 部署建议
1. 使用HTTPS协议
2. 配置适当的缓存策略
3. 启用Gzip压缩
4. 配置CDN加速

## 故障排查

### 登录失败
1. 检查后端服务是否启动
2. 检查网络连接
3. 查看浏览器控制台错误
4. 确认用户名密码正确

### Token问题
1. 检查Token是否过期
2. 查看localStorage中的Token
3. 测试Token刷新接口
4. 检查后端Token配置

### 权限问题
1. 确认用户角色和权限
2. 检查路由配置
3. 查看用户状态管理
4. 测试权限检查接口

## 联系支持

如果遇到问题，请：
1. 查看浏览器控制台错误日志
2. 检查网络请求响应
3. 确认后端服务状态
4. 参考API文档进行调试 