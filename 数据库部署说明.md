# SkyEye æ™ºèƒ½ç›‘æ§ç³»ç»Ÿæ•°æ®åº“éƒ¨ç½²è¯´æ˜

## æ¦‚è¿°

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜äº† SkyEye æ™ºèƒ½ç›‘æ§ç³»ç»Ÿçš„æ•°æ®åº“éƒ¨ç½²æ–¹æ¡ˆï¼ŒåŒ…æ‹¬ Docker å®¹å™¨åŒ–éƒ¨ç½²å’Œä¼ ç»Ÿéƒ¨ç½²ä¸¤ç§æ–¹å¼ã€‚

## ğŸ“‹ ç›®å½•ç»“æ„

```
skyv/
â”œâ”€â”€ docker/                              # Docker é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ Dockerfile.postgres              # PostgreSQL Docker é•œåƒ
â”‚   â”œâ”€â”€ postgresql.conf                  # PostgreSQL é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ pg_hba.conf                     # PostgreSQL è®¿é—®æ§åˆ¶
â”‚   â”œâ”€â”€ redis.conf                      # Redis é…ç½®æ–‡ä»¶
â”‚   â”œâ”€â”€ nginx/                          # Nginx é…ç½®
â”‚   â”‚   â””â”€â”€ default.conf                # åå‘ä»£ç†é…ç½®
â”‚   â””â”€â”€ init-scripts/                   # æ•°æ®åº“åˆå§‹åŒ–è„šæœ¬
â”‚       â””â”€â”€ 01-init-database.sh         # æ•°æ®åº“åˆå§‹åŒ–
â”œâ”€â”€ skyv-server/src/main/resources/db/migration/  # æ•°æ®åº“è¿ç§»è„šæœ¬
â”‚   â”œâ”€â”€ V1.0.0__init_database.sql       # æ•°æ®åº“åŸºç¡€é…ç½®
â”‚   â”œâ”€â”€ V1.0.1__create_user_tables.sql  # ç”¨æˆ·æƒé™è¡¨
â”‚   â”œâ”€â”€ V1.0.2__create_device_tables.sql # è®¾å¤‡ç®¡ç†è¡¨
â”‚   â”œâ”€â”€ V1.0.3__create_collector_tables.sql # æ•°æ®é‡‡é›†è¡¨
â”‚   â”œâ”€â”€ V1.0.4__create_alert_tables.sql # æŠ¥è­¦ç®¡ç†è¡¨
â”‚   â”œâ”€â”€ V1.0.5__create_system_tables.sql # ç³»ç»Ÿé…ç½®è¡¨
â”‚   â””â”€â”€ V1.0.6__init_basic_data.sql     # åŸºç¡€æ•°æ®åˆå§‹åŒ–
â”œâ”€â”€ docker-compose.yml                  # Docker Compose é…ç½®
â””â”€â”€ scripts/
    â””â”€â”€ deploy.sh                       # è‡ªåŠ¨éƒ¨ç½²è„šæœ¬
```

## ğŸš€ å¿«é€Ÿéƒ¨ç½²ï¼ˆæ¨èï¼‰

### 1. ä½¿ç”¨ Docker Compose ä¸€é”®éƒ¨ç½²

```bash
# å…‹éš†é¡¹ç›®
git clone <repository-url>
cd skyv

# æ‰§è¡Œéƒ¨ç½²è„šæœ¬
chmod +x scripts/deploy.sh
./scripts/deploy.sh

# æˆ–è€…ç›´æ¥ä½¿ç”¨ Docker Compose
docker-compose up -d
```

### 2. è®¿é—®æœåŠ¡

éƒ¨ç½²å®Œæˆåï¼Œå¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®ï¼š

- **å‰ç«¯åº”ç”¨**: http://localhost
- **åç«¯API**: http://localhost:8080
- **æ•°æ®åº“**: localhost:5432
- **Redis**: localhost:6379

### 3. é»˜è®¤è´¦å·

- **ç®¡ç†å‘˜**: `admin` / `admin123456`
- **æ™®é€šç”¨æˆ·**: `user` / `user123456`

## ğŸ“Š æ•°æ®åº“è®¾è®¡

### ä¸»è¦æ•°æ®è¡¨

| è¡¨å | æè¿° | è®°å½•æ•°ä¼°è®¡ |
|------|------|-----------|
| tb_users | ç”¨æˆ·ä¿¡æ¯è¡¨ | < 1000 |
| tb_roles | è§’è‰²è¡¨ | < 100 |
| tb_permissions | æƒé™è¡¨ | < 500 |
| tb_devices | è®¾å¤‡ä¿¡æ¯è¡¨ | < 10000 |
| tb_device_types | è®¾å¤‡ç±»å‹è¡¨ | < 500 |
| tb_collection_data | é‡‡é›†æ•°æ®è¡¨ï¼ˆåˆ†åŒºï¼‰ | > 1000ä¸‡ |
| tb_alerts | æŠ¥è­¦è®°å½•è¡¨ï¼ˆåˆ†åŒºï¼‰ | > 100ä¸‡ |
| tb_operation_logs | æ“ä½œæ—¥å¿—è¡¨ï¼ˆåˆ†åŒºï¼‰ | > 100ä¸‡ |

### åˆ†åŒºç­–ç•¥

ç³»ç»Ÿé‡‡ç”¨æŒ‰æœˆåˆ†åŒºçš„ç­–ç•¥æ¥ç®¡ç†å¤§æ•°æ®é‡è¡¨ï¼š

- **tb_collection_data**: é‡‡é›†æ•°æ®æŒ‰æœˆåˆ†åŒº
- **tb_alerts**: æŠ¥è­¦è®°å½•æŒ‰æœˆåˆ†åŒº  
- **tb_operation_logs**: æ“ä½œæ—¥å¿—æŒ‰æœˆåˆ†åŒº
- **tb_collection_logs**: é‡‡é›†æ—¥å¿—æŒ‰æœˆåˆ†åŒº

## ğŸ”§ è¯¦ç»†é…ç½®

### PostgreSQL é…ç½®

**æ€§èƒ½ä¼˜åŒ–å‚æ•°**:
```ini
shared_buffers = 256MB
effective_cache_size = 1GB  
maintenance_work_mem = 64MB
work_mem = 4MB
max_connections = 200
```

**æ—¥å¿—é…ç½®**:
```ini
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
```

### Redis é…ç½®

**å†…å­˜ç®¡ç†**:
```ini
maxmemory 256mb
maxmemory-policy allkeys-lru
```

**æŒä¹…åŒ–**:
```ini
appendonly yes
appendfsync everysec
save 900 1
save 300 10
save 60 10000
```

## ğŸ›  æ‰‹åŠ¨éƒ¨ç½²

### 1. ç¯å¢ƒè¦æ±‚

- **æ“ä½œç³»ç»Ÿ**: Linux/macOS/Windows
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **å†…å­˜**: æœ€å°‘ 4GBï¼Œæ¨è 8GB+
- **å­˜å‚¨**: æœ€å°‘ 20GB å¯ç”¨ç©ºé—´

### 2. æ•°æ®åº“å®‰è£…

#### æ–¹å¼ä¸€ï¼šä½¿ç”¨ Dockerï¼ˆæ¨èï¼‰

```bash
# æ„å»º PostgreSQL é•œåƒ
docker build -t skyeye-postgres:latest -f docker/Dockerfile.postgres docker/

# å¯åŠ¨æ•°æ®åº“å®¹å™¨
docker run -d \
  --name skyeye-postgres \
  -e POSTGRES_DB=skyeye \
  -e POSTGRES_USER=skyeye_app \
  -e POSTGRES_PASSWORD=skyeye_app_2024 \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  skyeye-postgres:latest
```

#### æ–¹å¼äºŒï¼šä¼ ç»Ÿå®‰è£…

```bash
# å®‰è£… PostgreSQL 15
sudo apt update
sudo apt install postgresql-15 postgresql-contrib-15

# åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·
sudo -u postgres psql <<EOF
CREATE DATABASE skyeye;
CREATE USER skyeye_app WITH PASSWORD 'skyeye_app_2024';
GRANT ALL PRIVILEGES ON DATABASE skyeye TO skyeye_app;
EOF

# æ‰§è¡Œæ•°æ®åº“è„šæœ¬
cd skyv-server/src/main/resources/db/migration
for file in V*.sql; do
  psql -h localhost -U skyeye_app -d skyeye -f "$file"
done
```

### 3. Redis å®‰è£…

```bash
# Docker æ–¹å¼
docker run -d \
  --name skyeye-redis \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --appendonly yes --requirepass skyeye_redis_2024

# ä¼ ç»Ÿå®‰è£…
sudo apt install redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

## ğŸ“ˆ ç›‘æ§å’Œç»´æŠ¤

### 1. æ•°æ®åº“ç›‘æ§

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database;

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC
LIMIT 10;
```

### 2. åˆ†åŒºç»´æŠ¤

```sql
-- åˆ›å»ºä¸‹ä¸ªæœˆçš„åˆ†åŒº
SELECT create_monthly_partition('tb_collection_data', DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month');

-- æ¸…ç†æ—§åˆ†åŒºï¼ˆä¿ç•™3ä¸ªæœˆï¼‰
SELECT drop_old_partitions('tb_collection_data', 3);
SELECT drop_old_partitions('tb_alerts', 12);
SELECT drop_old_partitions('tb_operation_logs', 6);
```

### 3. æ€§èƒ½ä¼˜åŒ–

```sql
-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ANALYZE;

-- é‡å»ºç´¢å¼•
REINDEX DATABASE skyeye;

-- æ¸…ç†ç©ºé—´
VACUUM FULL;
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. æ•°æ®åº“å®‰å…¨

- ä½¿ç”¨å¼ºå¯†ç 
- é™åˆ¶ç½‘ç»œè®¿é—®
- å¯ç”¨SSLè¿æ¥
- å®šæœŸå¤‡ä»½æ•°æ®

### 2. ç½‘ç»œå®‰å…¨

```yaml
# docker-compose.yml ç½‘ç»œé…ç½®
networks:
  skyeye-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

## ğŸ“¦ å¤‡ä»½å’Œæ¢å¤

### 1. æ•°æ®å¤‡ä»½

```bash
# å…¨é‡å¤‡ä»½
docker exec skyeye-postgres pg_dump -U skyeye_app skyeye > backup_$(date +%Y%m%d).sql

# å¢é‡å¤‡ä»½ï¼ˆä»…æ•°æ®ï¼‰
docker exec skyeye-postgres pg_dump -U skyeye_app --data-only skyeye > data_backup_$(date +%Y%m%d).sql
```

### 2. æ•°æ®æ¢å¤

```bash
# æ¢å¤æ•°æ®åº“
docker exec -i skyeye-postgres psql -U skyeye_app skyeye < backup_20241219.sql
```

## ğŸ› æ•…éšœæ’æŸ¥

### 1. å¸¸è§é—®é¢˜

**é—®é¢˜**: æ•°æ®åº“è¿æ¥å¤±è´¥
```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker-compose ps

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs postgres

# æµ‹è¯•è¿æ¥
docker exec skyeye-postgres pg_isready -U skyeye_app
```

**é—®é¢˜**: å†…å­˜ä¸è¶³
```bash
# æ£€æŸ¥å†…å­˜ä½¿ç”¨
docker stats

# è°ƒæ•´é…ç½®
# ä¿®æ”¹ postgresql.conf ä¸­çš„ shared_buffers ç­‰å‚æ•°
```

**é—®é¢˜**: ç£ç›˜ç©ºé—´ä¸è¶³
```bash
# æ¸…ç†æ—§æ•°æ®
SELECT drop_old_partitions('tb_collection_data', 1);

# æ¸…ç†Dockeré•œåƒ
docker system prune -a
```

### 2. æ—¥å¿—åˆ†æ

```bash
# PostgreSQL æ—¥å¿—
docker-compose logs postgres | tail -100

# Redis æ—¥å¿—
docker-compose logs redis | tail -100

# åº”ç”¨æ—¥å¿—
docker-compose logs skyeye-server | tail -100
```

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœåœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·ï¼š

1. æŸ¥çœ‹ç›¸å…³æ—¥å¿—æ–‡ä»¶
2. æ£€æŸ¥ç³»ç»Ÿèµ„æºä½¿ç”¨æƒ…å†µ
3. ç¡®è®¤ç½‘ç»œè¿æ¥æ­£å¸¸
4. å‚è€ƒæ•…éšœæ’æŸ¥éƒ¨åˆ†

## ğŸ”„ ç‰ˆæœ¬å‡çº§

### æ•°æ®åº“è¿ç§»

```bash
# å¤‡ä»½å½“å‰æ•°æ®
./scripts/backup.sh

# æ‰§è¡Œæ–°çš„è¿ç§»è„šæœ¬
docker exec skyeye-postgres psql -U skyeye_app -d skyeye -f /path/to/new_migration.sql

# éªŒè¯å‡çº§ç»“æœ
./scripts/verify.sh
```

---

**æ³¨æ„**: ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å‰è¯·åŠ¡å¿…è¿›è¡Œå……åˆ†æµ‹è¯•ï¼Œå¹¶åˆ¶å®šå®Œæ•´çš„å¤‡ä»½å’Œæ¢å¤è®¡åˆ’ã€‚ 