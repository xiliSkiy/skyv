# SkyEye 智能监控系统数据库部署说明

## 概述

本文档详细说明了 SkyEye 智能监控系统的数据库部署方案，包括 Docker 容器化部署和传统部署两种方式。

## 📋 目录结构

```
skyv/
├── docker/                              # Docker 配置文件
│   ├── Dockerfile.postgres              # PostgreSQL Docker 镜像
│   ├── postgresql.conf                  # PostgreSQL 配置文件
│   ├── pg_hba.conf                     # PostgreSQL 访问控制
│   ├── redis.conf                      # Redis 配置文件
│   ├── nginx/                          # Nginx 配置
│   │   └── default.conf                # 反向代理配置
│   └── init-scripts/                   # 数据库初始化脚本
│       └── 01-init-database.sh         # 数据库初始化
├── skyv-server/src/main/resources/db/migration/  # 数据库迁移脚本
│   ├── V1.0.0__init_database.sql       # 数据库基础配置
│   ├── V1.0.1__create_user_tables.sql  # 用户权限表
│   ├── V1.0.2__create_device_tables.sql # 设备管理表
│   ├── V1.0.3__create_collector_tables.sql # 数据采集表
│   ├── V1.0.4__create_alert_tables.sql # 报警管理表
│   ├── V1.0.5__create_system_tables.sql # 系统配置表
│   └── V1.0.6__init_basic_data.sql     # 基础数据初始化
├── docker-compose.yml                  # Docker Compose 配置
└── scripts/
    └── deploy.sh                       # 自动部署脚本
```

## 🚀 快速部署（推荐）

### 1. 使用 Docker Compose 一键部署

```bash
# 克隆项目
git clone <repository-url>
cd skyv

# 执行部署脚本
chmod +x scripts/deploy.sh
./scripts/deploy.sh

# 或者直接使用 Docker Compose
docker-compose up -d
```

### 2. 访问服务

部署完成后，可以通过以下地址访问：

- **前端应用**: http://localhost
- **后端API**: http://localhost:8080
- **数据库**: localhost:5432
- **Redis**: localhost:6379

### 3. 默认账号

- **管理员**: `admin` / `admin123456`
- **普通用户**: `user` / `user123456`

## 📊 数据库设计

### 主要数据表

| 表名 | 描述 | 记录数估计 |
|------|------|-----------|
| tb_users | 用户信息表 | < 1000 |
| tb_roles | 角色表 | < 100 |
| tb_permissions | 权限表 | < 500 |
| tb_devices | 设备信息表 | < 10000 |
| tb_device_types | 设备类型表 | < 500 |
| tb_collection_data | 采集数据表（分区） | > 1000万 |
| tb_alerts | 报警记录表（分区） | > 100万 |
| tb_operation_logs | 操作日志表（分区） | > 100万 |

### 分区策略

系统采用按月分区的策略来管理大数据量表：

- **tb_collection_data**: 采集数据按月分区
- **tb_alerts**: 报警记录按月分区  
- **tb_operation_logs**: 操作日志按月分区
- **tb_collection_logs**: 采集日志按月分区

## 🔧 详细配置

### PostgreSQL 配置

**性能优化参数**:
```ini
shared_buffers = 256MB
effective_cache_size = 1GB  
maintenance_work_mem = 64MB
work_mem = 4MB
max_connections = 200
```

**日志配置**:
```ini
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = on
log_disconnections = on
```

### Redis 配置

**内存管理**:
```ini
maxmemory 256mb
maxmemory-policy allkeys-lru
```

**持久化**:
```ini
appendonly yes
appendfsync everysec
save 900 1
save 300 10
save 60 10000
```

## 🛠 手动部署

### 1. 环境要求

- **操作系统**: Linux/macOS/Windows
- **Docker**: 20.10+
- **Docker Compose**: 1.29+
- **内存**: 最少 4GB，推荐 8GB+
- **存储**: 最少 20GB 可用空间

### 2. 数据库安装

#### 方式一：使用 Docker（推荐）

```bash
# 构建 PostgreSQL 镜像
docker build -t skyeye-postgres:latest -f docker/Dockerfile.postgres docker/

# 启动数据库容器
docker run -d \
  --name skyeye-postgres \
  -e POSTGRES_DB=skyeye \
  -e POSTGRES_USER=skyeye_app \
  -e POSTGRES_PASSWORD=skyeye_app_2024 \
  -p 5432:5432 \
  -v postgres_data:/var/lib/postgresql/data \
  skyeye-postgres:latest
```

#### 方式二：传统安装

```bash
# 安装 PostgreSQL 15
sudo apt update
sudo apt install postgresql-15 postgresql-contrib-15

# 创建数据库和用户
sudo -u postgres psql <<EOF
CREATE DATABASE skyeye;
CREATE USER skyeye_app WITH PASSWORD 'skyeye_app_2024';
GRANT ALL PRIVILEGES ON DATABASE skyeye TO skyeye_app;
EOF

# 执行数据库脚本
cd skyv-server/src/main/resources/db/migration
for file in V*.sql; do
  psql -h localhost -U skyeye_app -d skyeye -f "$file"
done
```

### 3. Redis 安装

```bash
# Docker 方式
docker run -d \
  --name skyeye-redis \
  -p 6379:6379 \
  -v redis_data:/data \
  redis:7-alpine redis-server --appendonly yes --requirepass skyeye_redis_2024

# 传统安装
sudo apt install redis-server
sudo systemctl enable redis-server
sudo systemctl start redis-server
```

## 📈 监控和维护

### 1. 数据库监控

```sql
-- 查看数据库大小
SELECT 
    pg_database.datname,
    pg_size_pretty(pg_database_size(pg_database.datname)) AS size
FROM pg_database;

-- 查看表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY pg_total_relation_size(schemaname||'.'||tablename) DESC;

-- 查看慢查询
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000
ORDER BY mean_time DESC
LIMIT 10;
```

### 2. 分区维护

```sql
-- 创建下个月的分区
SELECT create_monthly_partition('tb_collection_data', DATE_TRUNC('month', CURRENT_DATE) + INTERVAL '1 month');

-- 清理旧分区（保留3个月）
SELECT drop_old_partitions('tb_collection_data', 3);
SELECT drop_old_partitions('tb_alerts', 12);
SELECT drop_old_partitions('tb_operation_logs', 6);
```

### 3. 性能优化

```sql
-- 更新统计信息
ANALYZE;

-- 重建索引
REINDEX DATABASE skyeye;

-- 清理空间
VACUUM FULL;
```

## 🔒 安全配置

### 1. 数据库安全

- 使用强密码
- 限制网络访问
- 启用SSL连接
- 定期备份数据

### 2. 网络安全

```yaml
# docker-compose.yml 网络配置
networks:
  skyeye-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
```

## 📦 备份和恢复

### 1. 数据备份

```bash
# 全量备份
docker exec skyeye-postgres pg_dump -U skyeye_app skyeye > backup_$(date +%Y%m%d).sql

# 增量备份（仅数据）
docker exec skyeye-postgres pg_dump -U skyeye_app --data-only skyeye > data_backup_$(date +%Y%m%d).sql
```

### 2. 数据恢复

```bash
# 恢复数据库
docker exec -i skyeye-postgres psql -U skyeye_app skyeye < backup_20241219.sql
```

## 🐛 故障排查

### 1. 常见问题

**问题**: 数据库连接失败
```bash
# 检查容器状态
docker-compose ps

# 查看日志
docker-compose logs postgres

# 测试连接
docker exec skyeye-postgres pg_isready -U skyeye_app
```

**问题**: 内存不足
```bash
# 检查内存使用
docker stats

# 调整配置
# 修改 postgresql.conf 中的 shared_buffers 等参数
```

**问题**: 磁盘空间不足
```bash
# 清理旧数据
SELECT drop_old_partitions('tb_collection_data', 1);

# 清理Docker镜像
docker system prune -a
```

### 2. 日志分析

```bash
# PostgreSQL 日志
docker-compose logs postgres | tail -100

# Redis 日志
docker-compose logs redis | tail -100

# 应用日志
docker-compose logs skyeye-server | tail -100
```

## 📞 技术支持

如果在部署过程中遇到问题，请：

1. 查看相关日志文件
2. 检查系统资源使用情况
3. 确认网络连接正常
4. 参考故障排查部分

## 🔄 版本升级

### 数据库迁移

```bash
# 备份当前数据
./scripts/backup.sh

# 执行新的迁移脚本
docker exec skyeye-postgres psql -U skyeye_app -d skyeye -f /path/to/new_migration.sql

# 验证升级结果
./scripts/verify.sh
```

---

**注意**: 生产环境部署前请务必进行充分测试，并制定完整的备份和恢复计划。 