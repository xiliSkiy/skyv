# SkyEye 智能监控系统数据库设计详细说明

## 文档说明
本文档详细说明了SkyEye智能监控系统的数据库设计方案，包括表结构设计、索引策略、数据分区方案等。

---

## 1. 数据库选型与配置

### 1.1 PostgreSQL选型理由
- **JSON支持**：原生支持JSONB类型，适合存储设备配置等非结构化数据
- **性能优异**：支持复杂查询，并发性能好
- **扩展性强**：支持分区表、索引优化等高级特性
- **开源稳定**：成熟的开源数据库，社区活跃

### 1.2 数据库配置建议
```sql
-- 数据库创建
CREATE DATABASE skyeye 
    WITH ENCODING='UTF8' 
    LC_COLLATE='zh_CN.UTF-8' 
    LC_CTYPE='zh_CN.UTF-8';

-- 创建应用用户
CREATE USER skyeye_app WITH PASSWORD 'skyeye_app_2024';
GRANT ALL PRIVILEGES ON DATABASE skyeye TO skyeye_app;

-- 性能优化配置
ALTER SYSTEM SET shared_buffers = '256MB';
ALTER SYSTEM SET effective_cache_size = '1GB';
ALTER SYSTEM SET maintenance_work_mem = '64MB';
ALTER SYSTEM SET checkpoint_completion_target = 0.9;
ALTER SYSTEM SET wal_buffers = '16MB';
ALTER SYSTEM SET default_statistics_target = 100;
```

---

## 2. 完整表结构设计

### 2.1 用户权限管理表

#### tb_users (用户表)
```sql
CREATE TABLE tb_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名',
    password VARCHAR(255) NOT NULL COMMENT '密码哈希',
    name VARCHAR(100) NOT NULL COMMENT '真实姓名',
    email VARCHAR(100) COMMENT '邮箱',
    phone VARCHAR(20) COMMENT '手机号',
    avatar VARCHAR(255) COMMENT '头像URL',
    status INTEGER DEFAULT 1 COMMENT '状态：1启用 0禁用',
    last_login_ip INET COMMENT '最后登录IP',
    login_count INTEGER DEFAULT 0 COMMENT '登录次数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    last_login_at TIMESTAMP COMMENT '最后登录时间'
);

-- 创建索引
CREATE INDEX idx_users_username ON tb_users (username);
CREATE INDEX idx_users_email ON tb_users (email);
CREATE INDEX idx_users_status ON tb_users (status);

-- 添加注释
COMMENT ON TABLE tb_users IS '用户信息表';
```

#### tb_roles (角色表)
```sql
CREATE TABLE tb_roles (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL COMMENT '角色名称',
    code VARCHAR(50) UNIQUE NOT NULL COMMENT '角色编码',
    description VARCHAR(200) COMMENT '角色描述',
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统角色',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);

-- 初始化系统角色
INSERT INTO tb_roles (name, code, description, is_system, sort_order) VALUES
('超级管理员', 'SUPER_ADMIN', '系统超级管理员，拥有所有权限', TRUE, 1),
('系统管理员', 'ADMIN', '系统管理员，管理系统配置和用户', TRUE, 2),
('设备管理员', 'DEVICE_ADMIN', '设备管理员，管理设备和采集任务', TRUE, 3),
('普通用户', 'USER', '普通用户，查看监控数据', TRUE, 4);

COMMENT ON TABLE tb_roles IS '角色信息表';
```

#### tb_user_roles (用户角色关联表)
```sql
CREATE TABLE tb_user_roles (
    user_id BIGINT NOT NULL REFERENCES tb_users(id) ON DELETE CASCADE,
    role_id BIGINT NOT NULL REFERENCES tb_roles(id) ON DELETE CASCADE,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
    assigned_by BIGINT REFERENCES tb_users(id) COMMENT '分配人',
    PRIMARY KEY (user_id, role_id)
);

COMMENT ON TABLE tb_user_roles IS '用户角色关联表';
```

#### tb_permissions (权限表)
```sql
CREATE TABLE tb_permissions (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '权限名称',
    code VARCHAR(100) UNIQUE NOT NULL COMMENT '权限编码',
    resource VARCHAR(100) NOT NULL COMMENT '资源标识',
    action VARCHAR(50) NOT NULL COMMENT '操作类型',
    description VARCHAR(200) COMMENT '权限描述',
    parent_id BIGINT REFERENCES tb_permissions(id) COMMENT '父权限ID',
    is_menu BOOLEAN DEFAULT FALSE COMMENT '是否菜单权限',
    menu_url VARCHAR(200) COMMENT '菜单URL',
    menu_icon VARCHAR(50) COMMENT '菜单图标',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);

-- 初始化权限数据
INSERT INTO tb_permissions (name, code, resource, action, description, is_menu, menu_url, menu_icon, sort_order) VALUES
-- 系统管理
('系统管理', 'SYSTEM', 'system', 'menu', '系统管理菜单', TRUE, '/system', 'system', 1),
('用户管理', 'USER_MANAGE', 'user', 'manage', '用户管理权限', TRUE, '/system/users', 'user', 2),
('角色管理', 'ROLE_MANAGE', 'role', 'manage', '角色管理权限', TRUE, '/system/roles', 'role', 3),
-- 设备管理
('设备管理', 'DEVICE', 'device', 'menu', '设备管理菜单', TRUE, '/device', 'device', 10),
('设备查看', 'DEVICE_VIEW', 'device', 'view', '查看设备信息', FALSE, NULL, NULL, 11),
('设备添加', 'DEVICE_ADD', 'device', 'add', '添加设备', FALSE, NULL, NULL, 12),
('设备编辑', 'DEVICE_EDIT', 'device', 'edit', '编辑设备', FALSE, NULL, NULL, 13),
('设备删除', 'DEVICE_DELETE', 'device', 'delete', '删除设备', FALSE, NULL, NULL, 14),
-- 监控管理
('实时监控', 'MONITORING', 'monitoring', 'menu', '实时监控菜单', TRUE, '/monitoring', 'monitor', 20),
('监控查看', 'MONITORING_VIEW', 'monitoring', 'view', '查看监控画面', FALSE, NULL, NULL, 21),
-- 报警管理
('报警中心', 'ALERT', 'alert', 'menu', '报警中心菜单', TRUE, '/alerts', 'alert', 30),
('报警查看', 'ALERT_VIEW', 'alert', 'view', '查看报警信息', FALSE, NULL, NULL, 31),
('报警处理', 'ALERT_HANDLE', 'alert', 'handle', '处理报警事件', FALSE, NULL, NULL, 32);

COMMENT ON TABLE tb_permissions IS '权限信息表';
```

#### tb_role_permissions (角色权限关联表)
```sql
CREATE TABLE tb_role_permissions (
    role_id BIGINT NOT NULL REFERENCES tb_roles(id) ON DELETE CASCADE,
    permission_id BIGINT NOT NULL REFERENCES tb_permissions(id) ON DELETE CASCADE,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '分配时间',
    PRIMARY KEY (role_id, permission_id)
);

COMMENT ON TABLE tb_role_permissions IS '角色权限关联表';
```

### 2.2 设备管理相关表

#### tb_device_types (设备类型表)
```sql
CREATE TABLE tb_device_types (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '类型名称',
    code VARCHAR(50) UNIQUE NOT NULL COMMENT '类型编码',
    parent_id BIGINT REFERENCES tb_device_types(id) COMMENT '父类型ID',
    level INTEGER DEFAULT 0 COMMENT '层级',
    icon VARCHAR(100) COMMENT '图标',
    description TEXT COMMENT '描述',
    protocol_types JSONB COMMENT '支持的协议类型',
    default_config JSONB COMMENT '默认配置模板',
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统类型',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 初始化设备类型
INSERT INTO tb_device_types (name, code, level, icon, description, protocol_types, is_system, sort_order) VALUES
('网络设备', 'NETWORK', 0, 'network', '网络设备根分类', '["SNMP", "SSH", "HTTP"]', TRUE, 1),
('路由器', 'ROUTER', 1, 'router', '路由器设备', '["SNMP", "SSH"]', TRUE, 11),
('交换机', 'SWITCH', 1, 'switch', '交换机设备', '["SNMP", "SSH"]', TRUE, 12),
('监控设备', 'MONITOR', 0, 'camera', '监控设备根分类', '["RTSP", "HTTP", "ONVIF"]', TRUE, 2),
('摄像头', 'CAMERA', 1, 'video-camera', '监控摄像头', '["RTSP", "ONVIF"]', TRUE, 21),
('NVR', 'NVR', 1, 'nvr', '网络视频录像机', '["HTTP", "RTSP"]', TRUE, 22),
('服务器设备', 'SERVER', 0, 'server', '服务器设备根分类', '["SNMP", "SSH", "WMI", "HTTP"]', TRUE, 3),
('Linux服务器', 'LINUX_SERVER', 1, 'linux', 'Linux服务器', '["SSH", "SNMP"]', TRUE, 31),
('Windows服务器', 'WINDOWS_SERVER', 1, 'windows', 'Windows服务器', '["WMI", "SNMP"]', TRUE, 32),
('传感器设备', 'SENSOR', 0, 'sensor', '传感器设备根分类', '["MODBUS", "HTTP", "MQTT"]', TRUE, 4),
('温湿度传感器', 'TEMP_HUMIDITY', 1, 'temperature', '温湿度传感器', '["MODBUS", "HTTP"]', TRUE, 41);

-- 创建索引
CREATE INDEX idx_device_types_parent ON tb_device_types (parent_id);
CREATE INDEX idx_device_types_code ON tb_device_types (code);

COMMENT ON TABLE tb_device_types IS '设备类型表';
```

#### tb_device_areas (设备区域表)
```sql
CREATE TABLE tb_device_areas (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '区域名称',
    code VARCHAR(50) COMMENT '区域编码',
    parent_id BIGINT REFERENCES tb_device_areas(id) COMMENT '父区域ID',
    level INTEGER DEFAULT 0 COMMENT '层级',
    full_path VARCHAR(500) COMMENT '完整路径',
    description TEXT COMMENT '区域描述',
    location_info JSONB COMMENT '位置信息(经纬度等)',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 初始化区域数据
INSERT INTO tb_device_areas (name, code, level, full_path, description, sort_order) VALUES
('总部大楼', 'HQ_BUILDING', 0, '总部大楼', '公司总部大楼', 1),
('1楼大厅', 'HQ_FLOOR1_LOBBY', 1, '总部大楼/1楼大厅', '总部大楼一楼大厅', 11),
('2楼办公区', 'HQ_FLOOR2_OFFICE', 1, '总部大楼/2楼办公区', '总部大楼二楼办公区', 12),
('3楼会议室', 'HQ_FLOOR3_MEETING', 1, '总部大楼/3楼会议室', '总部大楼三楼会议室', 13),
('地下停车场', 'HQ_PARKING', 1, '总部大楼/地下停车场', '总部大楼地下停车场', 14),
('数据中心', 'DATA_CENTER', 0, '数据中心', '数据中心机房', 2),
('A机房', 'DC_ROOM_A', 1, '数据中心/A机房', '数据中心A机房', 21),
('B机房', 'DC_ROOM_B', 1, '数据中心/B机房', '数据中心B机房', 22);

-- 创建索引
CREATE INDEX idx_device_areas_parent ON tb_device_areas (parent_id);
CREATE INDEX idx_device_areas_code ON tb_device_areas (code);

COMMENT ON TABLE tb_device_areas IS '设备区域表';
```

#### tb_device_groups (设备分组表)
```sql
CREATE TABLE tb_device_groups (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '分组名称',
    description TEXT COMMENT '分组描述',
    color VARCHAR(7) COMMENT '分组颜色',
    created_by BIGINT REFERENCES tb_users(id) COMMENT '创建人',
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统分组',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 初始化系统分组
INSERT INTO tb_device_groups (name, description, color, is_system, sort_order) VALUES
('核心设备', '核心业务设备分组', '#FF6B6B', TRUE, 1),
('监控设备', '视频监控设备分组', '#4ECDC4', TRUE, 2),
('网络设备', '网络基础设备分组', '#45B7D1', TRUE, 3),
('服务器设备', '服务器设备分组', '#96CEB4', TRUE, 4),
('测试设备', '测试环境设备分组', '#FFEAA7', TRUE, 5);

COMMENT ON TABLE tb_device_groups IS '设备分组表';
```

#### tb_device_tags (设备标签表)
```sql
CREATE TABLE tb_device_tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL COMMENT '标签名称',
    color VARCHAR(7) DEFAULT '#409EFF' COMMENT '标签颜色',
    description VARCHAR(200) COMMENT '标签描述',
    created_by BIGINT REFERENCES tb_users(id) COMMENT '创建人',
    usage_count INTEGER DEFAULT 0 COMMENT '使用次数',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
);

-- 初始化标签数据
INSERT INTO tb_device_tags (name, color, description, usage_count) VALUES
('生产环境', '#67C23A', '生产环境设备', 0),
('测试环境', '#E6A23C', '测试环境设备', 0),
('核心业务', '#F56C6C', '核心业务相关设备', 0),
('备用设备', '#909399', '备用设备', 0),
('新采购', '#409EFF', '新采购设备', 0),
('待维护', '#E6A23C', '需要维护的设备', 0),
('高可用', '#67C23A', '高可用设备', 0);

COMMENT ON TABLE tb_device_tags IS '设备标签表';
```

#### tb_devices (设备表)
```sql
CREATE TABLE tb_devices (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '设备名称',
    device_type_id BIGINT NOT NULL REFERENCES tb_device_types(id) COMMENT '设备类型ID',
    area_id BIGINT REFERENCES tb_device_areas(id) COMMENT '设备区域ID',
    group_id BIGINT REFERENCES tb_device_groups(id) COMMENT '设备分组ID',
    
    -- 网络信息
    ip_address INET COMMENT '设备IP地址',
    port INTEGER COMMENT '设备端口',
    mac_address MACADDR COMMENT 'MAC地址',
    protocol VARCHAR(20) COMMENT '通信协议',
    
    -- 设备状态
    status INTEGER DEFAULT 1 COMMENT '设备状态：1在线 0离线 2故障 3维护',
    health_score INTEGER DEFAULT 100 COMMENT '健康评分0-100',
    
    -- 设备配置
    config JSONB COMMENT '设备配置JSON',
    credentials JSONB COMMENT '认证信息JSON(加密存储)',
    
    -- 位置信息
    location VARCHAR(200) COMMENT '物理位置描述',
    coordinates POINT COMMENT '地理坐标',
    
    -- 设备信息
    manufacturer VARCHAR(100) COMMENT '制造商',
    model VARCHAR(100) COMMENT '设备型号',
    serial_number VARCHAR(100) COMMENT '序列号',
    firmware_version VARCHAR(50) COMMENT '固件版本',
    purchase_date DATE COMMENT '采购日期',
    warranty_date DATE COMMENT '保修到期日期',
    
    -- 其他信息
    description TEXT COMMENT '设备描述',
    remark TEXT COMMENT '备注信息',
    
    -- 时间戳
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    last_online_at TIMESTAMP COMMENT '最后在线时间',
    last_collect_at TIMESTAMP COMMENT '最后采集时间'
);

-- 创建索引
CREATE INDEX idx_devices_type ON tb_devices (device_type_id);
CREATE INDEX idx_devices_area ON tb_devices (area_id);
CREATE INDEX idx_devices_group ON tb_devices (group_id);
CREATE INDEX idx_devices_status ON tb_devices (status);
CREATE INDEX idx_devices_ip ON tb_devices (ip_address);
CREATE INDEX idx_devices_name ON tb_devices USING gin(to_tsvector('english', name));
CREATE INDEX idx_devices_updated ON tb_devices (updated_at DESC);

COMMENT ON TABLE tb_devices IS '设备信息表';
```

#### tb_device_tag_relations (设备标签关联表)
```sql
CREATE TABLE tb_device_tag_relations (
    device_id BIGINT NOT NULL REFERENCES tb_devices(id) ON DELETE CASCADE,
    tag_id BIGINT NOT NULL REFERENCES tb_device_tags(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '关联时间',
    PRIMARY KEY (device_id, tag_id)
);

-- 创建索引
CREATE INDEX idx_device_tags_device ON tb_device_tag_relations (device_id);
CREATE INDEX idx_device_tags_tag ON tb_device_tag_relations (tag_id);

COMMENT ON TABLE tb_device_tag_relations IS '设备标签关联表';
```

### 2.3 数据采集相关表

#### tb_collectors (采集器表)
```sql
CREATE TABLE tb_collectors (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '采集器名称',
    type VARCHAR(50) NOT NULL COMMENT '采集器类型',
    version VARCHAR(20) COMMENT '版本号',
    
    -- 状态信息
    status INTEGER DEFAULT 1 COMMENT '状态：1在线 0离线 2告警',
    health_status VARCHAR(20) DEFAULT 'HEALTHY' COMMENT '健康状态',
    load_percentage INTEGER DEFAULT 0 COMMENT '负载百分比',
    
    -- 配置信息
    config JSONB COMMENT '采集器配置',
    capabilities JSONB COMMENT '能力描述',
    
    -- 网络信息
    host_ip INET COMMENT '主机IP',
    network_zone VARCHAR(100) COMMENT '网络区域',
    
    -- 主从信息
    is_main BOOLEAN DEFAULT FALSE COMMENT '是否主采集器',
    master_id BIGINT REFERENCES tb_collectors(id) COMMENT '主采集器ID',
    
    -- 统计信息
    total_devices INTEGER DEFAULT 0 COMMENT '分配设备总数',
    active_tasks INTEGER DEFAULT 0 COMMENT '活跃任务数',
    success_rate DECIMAL(5,2) DEFAULT 100.00 COMMENT '成功率',
    
    -- 时间信息
    last_heartbeat TIMESTAMP COMMENT '最后心跳时间',
    started_at TIMESTAMP COMMENT '启动时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 创建索引
CREATE INDEX idx_collectors_type ON tb_collectors (type);
CREATE INDEX idx_collectors_status ON tb_collectors (status);
CREATE INDEX idx_collectors_zone ON tb_collectors (network_zone);
CREATE INDEX idx_collectors_heartbeat ON tb_collectors (last_heartbeat DESC);

COMMENT ON TABLE tb_collectors IS '采集器信息表';
```

#### tb_metric_templates (指标模板表)
```sql
CREATE TABLE tb_metric_templates (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '模板名称',
    category VARCHAR(50) COMMENT '指标分类',
    device_type_id BIGINT REFERENCES tb_device_types(id) COMMENT '适用设备类型',
    
    -- 模板定义
    metrics JSONB NOT NULL COMMENT '指标定义JSON',
    collection_config JSONB COMMENT '采集配置',
    
    -- 模板属性
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统模板',
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    version VARCHAR(20) DEFAULT '1.0' COMMENT '模板版本',
    
    -- 统计信息
    usage_count INTEGER DEFAULT 0 COMMENT '使用次数',
    
    -- 创建信息
    created_by BIGINT REFERENCES tb_users(id) COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 创建索引
CREATE INDEX idx_metric_templates_type ON tb_metric_templates (device_type_id);
CREATE INDEX idx_metric_templates_category ON tb_metric_templates (category);
CREATE INDEX idx_metric_templates_system ON tb_metric_templates (is_system);

COMMENT ON TABLE tb_metric_templates IS '指标模板表';
```

#### tb_collection_tasks (采集任务表)
```sql
CREATE TABLE tb_collection_tasks (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '任务名称',
    description TEXT COMMENT '任务描述',
    
    -- 关联信息
    collector_id BIGINT REFERENCES tb_collectors(id) COMMENT '采集器ID',
    template_id BIGINT REFERENCES tb_metric_templates(id) COMMENT '指标模板ID',
    
    -- 调度配置
    schedule_type VARCHAR(20) NOT NULL COMMENT '调度类型：SIMPLE,CRON,EVENT',
    schedule_config JSONB NOT NULL COMMENT '调度配置JSON',
    
    -- 目标配置
    target_devices JSONB COMMENT '目标设备JSON数组',
    target_criteria JSONB COMMENT '目标筛选条件',
    
    -- 指标配置
    metrics_config JSONB COMMENT '指标配置JSON',
    collection_timeout INTEGER DEFAULT 30 COMMENT '采集超时时间(秒)',
    retry_times INTEGER DEFAULT 3 COMMENT '重试次数',
    
    -- 任务状态
    status INTEGER DEFAULT 1 COMMENT '状态：1启用 0禁用 2暂停 3错误',
    priority INTEGER DEFAULT 5 COMMENT '优先级1-10',
    
    -- 执行统计
    total_executions BIGINT DEFAULT 0 COMMENT '总执行次数',
    success_executions BIGINT DEFAULT 0 COMMENT '成功执行次数',
    last_execution_at TIMESTAMP COMMENT '最后执行时间',
    next_execution_at TIMESTAMP COMMENT '下次执行时间',
    
    -- 创建信息
    created_by BIGINT REFERENCES tb_users(id) COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 创建索引
CREATE INDEX idx_collection_tasks_collector ON tb_collection_tasks (collector_id);
CREATE INDEX idx_collection_tasks_status ON tb_collection_tasks (status);
CREATE INDEX idx_collection_tasks_next_exec ON tb_collection_tasks (next_execution_at);
CREATE INDEX idx_collection_tasks_priority ON tb_collection_tasks (priority DESC);

COMMENT ON TABLE tb_collection_tasks IS '采集任务表';
```

#### tb_collection_data (采集数据表)
```sql
CREATE TABLE tb_collection_data (
    id BIGSERIAL PRIMARY KEY,
    
    -- 关联信息
    device_id BIGINT NOT NULL REFERENCES tb_devices(id),
    collector_id BIGINT NOT NULL REFERENCES tb_collectors(id),
    task_id BIGINT REFERENCES tb_collection_tasks(id),
    
    -- 指标信息
    metric_name VARCHAR(100) NOT NULL COMMENT '指标名称',
    metric_category VARCHAR(50) COMMENT '指标分类',
    metric_value DECIMAL(20,6) COMMENT '指标数值',
    metric_unit VARCHAR(20) COMMENT '指标单位',
    metric_data JSONB COMMENT '复杂数据JSON存储',
    
    -- 质量信息
    quality_score INTEGER DEFAULT 100 COMMENT '数据质量评分',
    is_valid BOOLEAN DEFAULT TRUE COMMENT '数据是否有效',
    
    -- 时间信息
    collected_at TIMESTAMP NOT NULL COMMENT '采集时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '入库时间'
) PARTITION BY RANGE (collected_at);

-- 创建分区表（按月分区）
CREATE TABLE tb_collection_data_y2024m01 PARTITION OF tb_collection_data
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE tb_collection_data_y2024m02 PARTITION OF tb_collection_data
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');
CREATE TABLE tb_collection_data_y2024m03 PARTITION OF tb_collection_data
    FOR VALUES FROM ('2024-03-01') TO ('2024-04-01');

-- 创建索引（在分区表上）
CREATE INDEX idx_collection_data_device_time ON tb_collection_data (device_id, collected_at DESC);
CREATE INDEX idx_collection_data_metric_time ON tb_collection_data (metric_name, collected_at DESC);
CREATE INDEX idx_collection_data_collector ON tb_collection_data (collector_id, collected_at DESC);

COMMENT ON TABLE tb_collection_data IS '采集数据表（按月分区）';
```

#### tb_collection_logs (采集日志表)
```sql
CREATE TABLE tb_collection_logs (
    id BIGSERIAL PRIMARY KEY,
    task_id BIGINT REFERENCES tb_collection_tasks(id),
    collector_id BIGINT REFERENCES tb_collectors(id),
    device_id BIGINT REFERENCES tb_devices(id),
    
    -- 执行信息
    execution_id UUID DEFAULT gen_random_uuid() COMMENT '执行ID',
    start_time TIMESTAMP NOT NULL COMMENT '开始时间',
    end_time TIMESTAMP COMMENT '结束时间',
    duration_ms INTEGER COMMENT '执行时长(毫秒)',
    
    -- 结果信息
    status VARCHAR(20) NOT NULL COMMENT '执行状态',
    success_count INTEGER DEFAULT 0 COMMENT '成功指标数',
    failed_count INTEGER DEFAULT 0 COMMENT '失败指标数',
    error_message TEXT COMMENT '错误信息',
    
    -- 详细信息
    execution_details JSONB COMMENT '执行详情JSON',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) PARTITION BY RANGE (created_at);

-- 创建分区表（按月分区）
CREATE TABLE tb_collection_logs_y2024m01 PARTITION OF tb_collection_logs
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');

-- 创建索引
CREATE INDEX idx_collection_logs_task ON tb_collection_logs (task_id, created_at DESC);
CREATE INDEX idx_collection_logs_status ON tb_collection_logs (status, created_at DESC);

COMMENT ON TABLE tb_collection_logs IS '采集执行日志表（按月分区）';
```

### 2.4 报警管理相关表

#### tb_alert_rules (报警规则表)
```sql
CREATE TABLE tb_alert_rules (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL COMMENT '规则名称',
    description TEXT COMMENT '规则描述',
    
    -- 适用范围
    device_type_id BIGINT REFERENCES tb_device_types(id) COMMENT '设备类型ID',
    device_group_id BIGINT REFERENCES tb_device_groups(id) COMMENT '设备分组ID',
    target_devices JSONB COMMENT '目标设备JSON数组',
    
    -- 触发条件
    metric_name VARCHAR(100) COMMENT '指标名称',
    condition_type VARCHAR(20) NOT NULL COMMENT '条件类型：GT,LT,EQ,NE,IN,CONTAINS',
    threshold_value DECIMAL(20,6) COMMENT '阈值',
    threshold_config JSONB COMMENT '复杂阈值配置',
    
    -- 报警级别
    level VARCHAR(20) NOT NULL COMMENT '报警级别：CRITICAL,HIGH,MEDIUM,LOW',
    severity INTEGER DEFAULT 1 COMMENT '严重程度1-10',
    
    -- 触发配置
    continuous_count INTEGER DEFAULT 1 COMMENT '连续触发次数',
    time_window INTEGER DEFAULT 300 COMMENT '时间窗口(秒)',
    recovery_condition JSONB COMMENT '恢复条件',
    
    -- 通知配置
    notification_config JSONB COMMENT '通知配置JSON',
    escalation_config JSONB COMMENT '升级配置JSON',
    
    -- 规则状态
    enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    
    -- 统计信息
    trigger_count BIGINT DEFAULT 0 COMMENT '触发次数',
    last_trigger_at TIMESTAMP COMMENT '最后触发时间',
    
    -- 创建信息
    created_by BIGINT REFERENCES tb_users(id) COMMENT '创建人',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
);

-- 创建索引
CREATE INDEX idx_alert_rules_device_type ON tb_alert_rules (device_type_id);
CREATE INDEX idx_alert_rules_metric ON tb_alert_rules (metric_name);
CREATE INDEX idx_alert_rules_level ON tb_alert_rules (level);
CREATE INDEX idx_alert_rules_enabled ON tb_alert_rules (enabled);

COMMENT ON TABLE tb_alert_rules IS '报警规则表';
```

#### tb_alerts (报警记录表)
```sql
CREATE TABLE tb_alerts (
    id BIGSERIAL PRIMARY KEY,
    
    -- 关联信息
    rule_id BIGINT REFERENCES tb_alert_rules(id) COMMENT '报警规则ID',
    device_id BIGINT NOT NULL REFERENCES tb_devices(id) COMMENT '设备ID',
    
    -- 报警信息
    title VARCHAR(200) NOT NULL COMMENT '报警标题',
    description TEXT COMMENT '报警描述',
    level VARCHAR(20) NOT NULL COMMENT '报警级别',
    category VARCHAR(50) COMMENT '报警分类',
    
    -- 触发信息
    trigger_value DECIMAL(20,6) COMMENT '触发值',
    threshold_value DECIMAL(20,6) COMMENT '阈值',
    trigger_condition VARCHAR(500) COMMENT '触发条件描述',
    trigger_data JSONB COMMENT '触发数据JSON',
    
    -- 状态信息
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态：PENDING,PROCESSING,RESOLVED,IGNORED,CLOSED',
    
    -- 处理信息
    processed_by BIGINT REFERENCES tb_users(id) COMMENT '处理人',
    processed_at TIMESTAMP COMMENT '处理时间',
    process_note TEXT COMMENT '处理备注',
    resolution TEXT COMMENT '解决方案',
    
    -- 通知信息
    notification_sent BOOLEAN DEFAULT FALSE COMMENT '是否已发送通知',
    notification_log JSONB COMMENT '通知发送日志',
    
    -- 时间信息
    trigger_time TIMESTAMP NOT NULL COMMENT '触发时间',
    resolved_time TIMESTAMP COMMENT '解决时间',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间'
) PARTITION BY RANGE (trigger_time);

-- 创建分区表（按月分区）
CREATE TABLE tb_alerts_y2024m01 PARTITION OF tb_alerts
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE tb_alerts_y2024m02 PARTITION OF tb_alerts
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- 创建索引
CREATE INDEX idx_alerts_device_time ON tb_alerts (device_id, trigger_time DESC);
CREATE INDEX idx_alerts_status ON tb_alerts (status, trigger_time DESC);
CREATE INDEX idx_alerts_level ON tb_alerts (level, trigger_time DESC);
CREATE INDEX idx_alerts_rule ON tb_alerts (rule_id, trigger_time DESC);

COMMENT ON TABLE tb_alerts IS '报警记录表（按月分区）';
```

### 2.5 系统配置相关表

#### tb_system_settings (系统配置表)
```sql
CREATE TABLE tb_system_settings (
    id BIGSERIAL PRIMARY KEY,
    group_name VARCHAR(50) NOT NULL COMMENT '配置分组',
    key_name VARCHAR(100) NOT NULL COMMENT '配置键名',
    value TEXT COMMENT '配置值',
    value_type VARCHAR(20) DEFAULT 'STRING' COMMENT '值类型：STRING,INTEGER,BOOLEAN,JSON',
    default_value TEXT COMMENT '默认值',
    description VARCHAR(200) COMMENT '配置描述',
    is_encrypted BOOLEAN DEFAULT FALSE COMMENT '是否加密存储',
    is_readonly BOOLEAN DEFAULT FALSE COMMENT '是否只读',
    validation_rule VARCHAR(500) COMMENT '验证规则',
    sort_order INTEGER DEFAULT 0 COMMENT '排序',
    updated_by BIGINT REFERENCES tb_users(id) COMMENT '更新人',
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '更新时间',
    UNIQUE(group_name, key_name)
);

-- 初始化系统配置
INSERT INTO tb_system_settings (group_name, key_name, value, value_type, description, sort_order) VALUES
-- 系统基本配置
('system', 'name', 'SkyEye智能监控系统', 'STRING', '系统名称', 1),
('system', 'version', '1.0.0', 'STRING', '系统版本', 2),
('system', 'description', '智能视频监控与安防管理系统', 'STRING', '系统描述', 3),
('system', 'timezone', 'Asia/Shanghai', 'STRING', '系统时区', 4),
('system', 'language', 'zh_CN', 'STRING', '系统语言', 5),

-- 主题配置
('theme', 'primary_color', '#1e3c72', 'STRING', '主色调', 10),
('theme', 'secondary_color', '#2a5298', 'STRING', '辅助色', 11),
('theme', 'dark_mode', 'false', 'BOOLEAN', '深色模式', 12),

-- 安全配置
('security', 'jwt_expiration', '86400000', 'INTEGER', 'JWT过期时间(毫秒)', 20),
('security', 'password_min_length', '8', 'INTEGER', '密码最小长度', 21),
('security', 'login_max_attempts', '5', 'INTEGER', '最大登录尝试次数', 22),

-- 采集配置
('collector', 'default_timeout', '30', 'INTEGER', '默认采集超时时间(秒)', 30),
('collector', 'max_concurrent_tasks', '100', 'INTEGER', '最大并发任务数', 31),
('collector', 'data_retention_days', '90', 'INTEGER', '数据保留天数', 32),

-- 报警配置
('alert', 'default_notification', 'true', 'BOOLEAN', '默认启用通知', 40),
('alert', 'max_pending_alerts', '1000', 'INTEGER', '最大待处理报警数', 41);

-- 创建索引
CREATE INDEX idx_system_settings_group ON tb_system_settings (group_name);
CREATE UNIQUE INDEX idx_system_settings_unique ON tb_system_settings (group_name, key_name);

COMMENT ON TABLE tb_system_settings IS '系统配置表';
```

#### tb_operation_logs (操作日志表)
```sql
CREATE TABLE tb_operation_logs (
    id BIGSERIAL PRIMARY KEY,
    
    -- 用户信息
    user_id BIGINT REFERENCES tb_users(id) COMMENT '操作用户ID',
    username VARCHAR(50) COMMENT '用户名',
    
    -- 操作信息
    module VARCHAR(50) NOT NULL COMMENT '操作模块',
    operation VARCHAR(100) NOT NULL COMMENT '操作类型',
    operation_desc VARCHAR(200) COMMENT '操作描述',
    
    -- 目标信息
    target_type VARCHAR(50) COMMENT '操作对象类型',
    target_id BIGINT COMMENT '操作对象ID',
    target_name VARCHAR(200) COMMENT '操作对象名称',
    
    -- 请求信息
    request_method VARCHAR(10) COMMENT '请求方法',
    request_url VARCHAR(500) COMMENT '请求URL',
    request_params JSONB COMMENT '请求参数',
    
    -- 响应信息
    response_status INTEGER COMMENT '响应状态码',
    response_time INTEGER COMMENT '响应时间(毫秒)',
    
    -- 详细信息
    details JSONB COMMENT '操作详情JSON',
    before_data JSONB COMMENT '操作前数据',
    after_data JSONB COMMENT '操作后数据',
    
    -- 客户端信息
    ip_address INET COMMENT 'IP地址',
    user_agent TEXT COMMENT '用户代理',
    
    -- 结果信息
    success BOOLEAN DEFAULT TRUE COMMENT '是否成功',
    error_message TEXT COMMENT '错误信息',
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间'
) PARTITION BY RANGE (created_at);

-- 创建分区表（按月分区）
CREATE TABLE tb_operation_logs_y2024m01 PARTITION OF tb_operation_logs
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
CREATE TABLE tb_operation_logs_y2024m02 PARTITION OF tb_operation_logs
    FOR VALUES FROM ('2024-02-01') TO ('2024-03-01');

-- 创建索引
CREATE INDEX idx_operation_logs_user ON tb_operation_logs (user_id, created_at DESC);
CREATE INDEX idx_operation_logs_module ON tb_operation_logs (module, created_at DESC);
CREATE INDEX idx_operation_logs_operation ON tb_operation_logs (operation, created_at DESC);
CREATE INDEX idx_operation_logs_target ON tb_operation_logs (target_type, target_id, created_at DESC);
CREATE INDEX idx_operation_logs_ip ON tb_operation_logs (ip_address, created_at DESC);

COMMENT ON TABLE tb_operation_logs IS '操作日志表（按月分区）';
```

---

## 3. 索引优化策略

### 3.1 查询性能优化索引
```sql
-- 复合索引优化常用查询
CREATE INDEX idx_devices_type_status_area ON tb_devices (device_type_id, status, area_id);
CREATE INDEX idx_collection_data_device_metric_time ON tb_collection_data (device_id, metric_name, collected_at DESC);
CREATE INDEX idx_alerts_device_status_level ON tb_alerts (device_id, status, level, trigger_time DESC);

-- 全文搜索索引
CREATE INDEX idx_devices_search ON tb_devices USING gin(
    to_tsvector('english', coalesce(name, '') || ' ' || coalesce(description, ''))
);

-- JSON字段索引
CREATE INDEX idx_devices_config_gin ON tb_devices USING gin(config);
CREATE INDEX idx_collection_data_metric_gin ON tb_collection_data USING gin(metric_data);
```

### 3.2 分区表管理
```sql
-- 自动创建分区的函数
CREATE OR REPLACE FUNCTION create_monthly_partition(table_name TEXT, start_date DATE)
RETURNS void AS $$
DECLARE
    partition_name TEXT;
    end_date DATE;
BEGIN
    partition_name := table_name || '_y' || to_char(start_date, 'YYYY') || 'm' || to_char(start_date, 'MM');
    end_date := start_date + INTERVAL '1 month';
    
    EXECUTE format('CREATE TABLE IF NOT EXISTS %I PARTITION OF %I FOR VALUES FROM (%L) TO (%L)',
                   partition_name, table_name, start_date, end_date);
END;
$$ LANGUAGE plpgsql;

-- 定期清理旧分区的函数
CREATE OR REPLACE FUNCTION drop_old_partitions(table_name TEXT, retention_months INTEGER)
RETURNS void AS $$
DECLARE
    partition_name TEXT;
    cutoff_date DATE;
BEGIN
    cutoff_date := date_trunc('month', CURRENT_DATE) - (retention_months || ' months')::INTERVAL;
    
    FOR partition_name IN 
        SELECT schemaname||'.'||tablename 
        FROM pg_tables 
        WHERE tablename LIKE table_name || '_y%m%'
        AND tablename < table_name || '_y' || to_char(cutoff_date, 'YYYY') || 'm' || to_char(cutoff_date, 'MM')
    LOOP
        EXECUTE 'DROP TABLE IF EXISTS ' || partition_name;
    END LOOP;
END;
$$ LANGUAGE plpgsql;
```

---

## 4. 数据维护策略

### 4.1 数据清理策略
```sql
-- 清理过期采集数据（保留3个月）
DELETE FROM tb_collection_data 
WHERE collected_at < CURRENT_DATE - INTERVAL '3 months';

-- 清理过期操作日志（保留6个月）
DELETE FROM tb_operation_logs 
WHERE created_at < CURRENT_DATE - INTERVAL '6 months';

-- 清理已关闭的报警记录（保留1年）
DELETE FROM tb_alerts 
WHERE status = 'CLOSED' AND resolved_time < CURRENT_DATE - INTERVAL '1 year';
```

### 4.2 统计信息更新
```sql
-- 更新设备标签使用次数
UPDATE tb_device_tags SET usage_count = (
    SELECT COUNT(*) FROM tb_device_tag_relations WHERE tag_id = tb_device_tags.id
);

-- 更新采集器设备分配数量
UPDATE tb_collectors SET total_devices = (
    SELECT COUNT(DISTINCT device_id) 
    FROM tb_collection_tasks t 
    JOIN jsonb_array_elements_text(t.target_devices) device_id ON true
    WHERE t.collector_id = tb_collectors.id
);

-- 更新指标模板使用次数
UPDATE tb_metric_templates SET usage_count = (
    SELECT COUNT(*) FROM tb_collection_tasks WHERE template_id = tb_metric_templates.id
);
```

### 4.3 数据备份策略
```sql
-- 创建备份脚本
-- 1. 全量备份（每周执行）
pg_dump -h localhost -U skyeye_app -d skyeye -f skyeye_full_$(date +%Y%m%d).sql

-- 2. 增量备份（每日执行）
pg_dump -h localhost -U skyeye_app -d skyeye --inserts --data-only \
  --table=tb_collection_data --table=tb_alerts --table=tb_operation_logs \
  -f skyeye_incremental_$(date +%Y%m%d).sql

-- 3. 配置数据备份（配置变更时执行）
pg_dump -h localhost -U skyeye_app -d skyeye --inserts --data-only \
  --table=tb_system_settings --table=tb_alert_rules --table=tb_metric_templates \
  -f skyeye_config_$(date +%Y%m%d_%H%M%S).sql
```

---

## 5. 性能监控与优化

### 5.1 性能监控查询
```sql
-- 监控慢查询
SELECT query, mean_time, calls, total_time
FROM pg_stat_statements
WHERE mean_time > 1000  -- 超过1秒的查询
ORDER BY mean_time DESC
LIMIT 10;

-- 监控表大小
SELECT 
    schemaname,
    tablename,
    pg_size_pretty(pg_total_relation_size(schemaname||'.'||tablename)) as size,
    pg_total_relation_size(schemaname||'.'||tablename) as size_bytes
FROM pg_tables
WHERE schemaname = 'public'
ORDER BY size_bytes DESC;

-- 监控索引使用情况
SELECT 
    schemaname,
    tablename,
    indexname,
    idx_scan,
    idx_tup_read,
    idx_tup_fetch
FROM pg_stat_user_indexes
WHERE idx_scan = 0  -- 未使用的索引
ORDER BY schemaname, tablename;
```

### 5.2 性能优化建议
```sql
-- 更新表统计信息
ANALYZE tb_devices;
ANALYZE tb_collection_data;
ANALYZE tb_alerts;

-- 重建索引（定期维护）
REINDEX TABLE tb_collection_data;
REINDEX TABLE tb_alerts;

-- 清理无用数据
VACUUM FULL tb_collection_data;
VACUUM FULL tb_operation_logs;
```

---

## 6. 数据安全与权限

### 6.1 数据加密
```sql
-- 创建加密扩展
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- 加密敏感字段的函数
CREATE OR REPLACE FUNCTION encrypt_sensitive_data(data TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN encode(encrypt(data::bytea, 'skyeye_encryption_key', 'aes'), 'base64');
END;
$$ LANGUAGE plpgsql;

-- 解密敏感字段的函数
CREATE OR REPLACE FUNCTION decrypt_sensitive_data(encrypted_data TEXT)
RETURNS TEXT AS $$
BEGIN
    RETURN convert_from(decrypt(decode(encrypted_data, 'base64'), 'skyeye_encryption_key', 'aes'), 'UTF8');
END;
$$ LANGUAGE plpgsql;
```

### 6.2 行级安全策略
```sql
-- 启用行级安全
ALTER TABLE tb_devices ENABLE ROW LEVEL SECURITY;

-- 创建安全策略（用户只能访问自己权限范围内的设备）
CREATE POLICY device_access_policy ON tb_devices
    FOR ALL
    TO skyeye_app
    USING (
        id IN (
            SELECT d.id FROM tb_devices d
            JOIN tb_device_areas da ON d.area_id = da.id
            -- 这里可以根据用户权限进行过滤
        )
    );
```

---

## 7. 总结

### 7.1 设计特点
1. **模块化设计**：按功能模块划分表结构，便于维护和扩展
2. **灵活配置**：大量使用JSONB字段存储配置信息，支持动态扩展
3. **性能优化**：合理的索引设计和分区策略，支持大数据量场景
4. **数据安全**：完善的权限控制和数据加密机制
5. **易于维护**：标准化的命名规范和完整的注释说明

### 7.2 扩展建议
1. **时序数据库**：如果采集数据量很大，可考虑引入TimescaleDB扩展
2. **读写分离**：可配置主从复制，实现读写分离提升性能
3. **数据归档**：建立历史数据归档机制，保持主库性能
4. **监控告警**：建立数据库性能监控和告警机制

该数据库设计方案充分考虑了系统的功能需求、性能要求和扩展性，为SkyEye智能监控系统提供了坚实的数据存储基础。 