# SkyEye 智能监控系统后端架构设计

## 文档说明
本文档基于功能需求清单，设计了一套基于Java技术栈的后端架构方案。架构设计遵循简洁实用原则，使用最少的基础中间件（PostgreSQL + Redis），确保快速实现和后续扩展。

---

## 1. 架构概览

### 1.1 整体架构图
```
┌─────────────────────────────────────────────────────────────┐
│                        前端层 (Vue3)                        │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                     API网关层 (Nginx)                       │
└─────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────┐
│                   Spring Boot 应用层                        │
├─────────────────┬─────────────────┬─────────────────────────┤
│   Web控制器     │   业务服务层     │     数据采集引擎        │
│   (Controller)  │   (Service)     │   (Collector Engine)   │
└─────────────────┴─────────────────┴─────────────────────────┘
                                │
                                ▼
┌─────────────────┬─────────────────┬─────────────────────────┐
│   PostgreSQL    │     Redis       │      文件存储           │
│   (主数据库)     │   (缓存/会话)    │   (视频/图片/日志)       │
└─────────────────┴─────────────────┴─────────────────────────┘
```

### 1.2 核心设计原则
- **单体优先**：采用Spring Boot单体架构，避免微服务复杂性
- **模块化设计**：代码按功能模块组织，便于维护和扩展
- **插件化扩展**：设备采集支持插件化，方便新设备类型接入
- **异步处理**：使用Spring异步机制处理耗时操作
- **缓存优化**：合理使用Redis缓存提升性能

---

## 2. 技术栈选型

### 2.1 核心框架
- **Spring Boot 3.x**：主应用框架
- **Spring Security 6.x**：安全认证框架
- **Spring Data JPA**：数据访问层
- **Spring WebSocket**：实时通信
- **Spring Task**：任务调度

### 2.2 数据存储
- **PostgreSQL 15+**：主数据库，支持JSON字段存储设备配置
- **Redis 7.x**：缓存、会话存储、消息队列

### 2.3 其他组件
- **JWT**：无状态认证
- **Jackson**：JSON序列化
- **Hibernate Validator**：参数校验
- **Logback**：日志框架
- **Maven**：项目构建

---

## 3. 项目结构设计

### 3.1 包结构
```
com.skyeye
├── SkyEyeApplication.java                    # 启动类
├── common/                                   # 公共模块
│   ├── config/                              # 配置类
│   ├── constant/                            # 常量定义
│   ├── exception/                           # 异常处理
│   ├── response/                            # 响应封装
│   └── util/                                # 工具类
├── security/                                # 安全模块
│   ├── config/                              # 安全配置
│   ├── filter/                              # 安全过滤器
│   ├── handler/                             # 安全处理器
│   └── service/                             # 安全服务
├── auth/                                    # 认证模块
│   ├── controller/                          # 认证控制器
│   ├── dto/                                 # 数据传输对象
│   ├── entity/                              # 实体类
│   ├── repository/                          # 数据访问层
│   └── service/                             # 业务服务层
├── user/                                    # 用户管理模块
├── device/                                  # 设备管理模块
├── collector/                               # 数据采集模块
│   ├── engine/                              # 采集引擎
│   ├── plugin/                              # 采集插件
│   │   ├── snmp/                           # SNMP采集插件
│   │   ├── http/                           # HTTP采集插件
│   │   ├── ssh/                            # SSH采集插件
│   │   └── custom/                         # 自定义采集插件
│   └── scheduler/                          # 采集调度器
├── monitoring/                              # 监控模块
├── alert/                                   # 报警模块
├── analytics/                               # 数据分析模块
├── task/                                    # 任务调度模块
├── history/                                 # 历史记录模块
└── system/                                  # 系统设置模块
```

### 3.2 模块职责说明
- **common**：通用工具、配置、异常处理
- **security**：Spring Security配置和JWT处理
- **auth**：用户认证、登录、密码管理
- **user**：用户管理、角色权限
- **device**：设备CRUD、设备分类管理
- **collector**：数据采集引擎和插件系统
- **monitoring**：实时监控、视频流处理
- **alert**：报警规则、报警处理
- **analytics**：数据分析、AI集成
- **task**：任务调度、定时任务
- **history**：历史数据查询、数据导出
- **system**：系统配置、系统管理

---

## 4. 数据库设计

### 4.1 核心数据表

#### 用户权限相关表
```sql
-- 用户表
CREATE TABLE tb_users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    name VARCHAR(100) NOT NULL,
    email VARCHAR(100),
    phone VARCHAR(20),
    avatar VARCHAR(255),
    status INTEGER DEFAULT 1, -- 1:启用 0:禁用
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP
);

-- 角色表
CREATE TABLE tb_roles (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    description VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 用户角色关联表
CREATE TABLE tb_user_roles (
    user_id BIGINT REFERENCES tb_users(id),
    role_id BIGINT REFERENCES tb_roles(id),
    PRIMARY KEY (user_id, role_id)
);

-- 权限表
CREATE TABLE tb_permissions (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    resource VARCHAR(100) NOT NULL,
    action VARCHAR(50) NOT NULL,
    description VARCHAR(200)
);

-- 角色权限关联表
CREATE TABLE tb_role_permissions (
    role_id BIGINT REFERENCES tb_roles(id),
    permission_id BIGINT REFERENCES tb_permissions(id),
    PRIMARY KEY (role_id, permission_id)
);
```

#### 设备管理相关表
```sql
-- 设备类型表
CREATE TABLE tb_device_types (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    code VARCHAR(50) UNIQUE NOT NULL,
    parent_id BIGINT REFERENCES tb_device_types(id),
    icon VARCHAR(100),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 设备区域表
CREATE TABLE tb_device_areas (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    parent_id BIGINT REFERENCES tb_device_areas(id),
    level INTEGER DEFAULT 0,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 设备分组表
CREATE TABLE tb_device_groups (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    created_by BIGINT REFERENCES tb_users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 设备标签表
CREATE TABLE tb_device_tags (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(50) UNIQUE NOT NULL,
    color VARCHAR(7), -- HEX颜色值
    description VARCHAR(200)
);

-- 设备表
CREATE TABLE tb_devices (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    device_type_id BIGINT REFERENCES tb_device_types(id),
    area_id BIGINT REFERENCES tb_device_areas(id),
    group_id BIGINT REFERENCES tb_device_groups(id),
    ip_address INET,
    port INTEGER,
    protocol VARCHAR(20), -- SNMP, HTTP, SSH等
    status INTEGER DEFAULT 1, -- 1:在线 0:离线 2:故障
    config JSONB, -- 设备配置JSON
    location VARCHAR(200),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_online_at TIMESTAMP
);

-- 设备标签关联表
CREATE TABLE tb_device_tag_relations (
    device_id BIGINT REFERENCES tb_devices(id),
    tag_id BIGINT REFERENCES tb_device_tags(id),
    PRIMARY KEY (device_id, tag_id)
);
```

#### 数据采集相关表
```sql
-- 采集器表
CREATE TABLE tb_collectors (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    type VARCHAR(50) NOT NULL, -- SNMP, HTTP, SSH等
    version VARCHAR(20),
    status INTEGER DEFAULT 1, -- 1:在线 0:离线 2:告警
    config JSONB, -- 采集器配置
    network_zone VARCHAR(100),
    is_main BOOLEAN DEFAULT FALSE, -- 是否主采集器
    load_percentage INTEGER DEFAULT 0, -- 负载百分比
    last_heartbeat TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 指标模板表
CREATE TABLE tb_metric_templates (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    category VARCHAR(50), -- CPU, 内存, 网络等
    metrics JSONB, -- 指标定义JSON
    device_type_id BIGINT REFERENCES tb_device_types(id),
    is_system BOOLEAN DEFAULT FALSE, -- 是否系统模板
    created_by BIGINT REFERENCES tb_users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 采集任务表
CREATE TABLE tb_collection_tasks (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    collector_id BIGINT REFERENCES tb_collectors(id),
    schedule_type VARCHAR(20), -- SIMPLE, CRON, EVENT
    schedule_config JSONB, -- 调度配置
    target_devices JSONB, -- 目标设备JSON数组
    metrics_config JSONB, -- 指标配置
    status INTEGER DEFAULT 1, -- 1:启用 0:禁用 2:暂停
    created_by BIGINT REFERENCES tb_users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 采集数据表
CREATE TABLE tb_collection_data (
    id BIGSERIAL PRIMARY KEY,
    device_id BIGINT REFERENCES tb_devices(id),
    collector_id BIGINT REFERENCES tb_collectors(id),
    metric_name VARCHAR(100) NOT NULL,
    metric_value DECIMAL(20,6),
    metric_unit VARCHAR(20),
    metric_data JSONB, -- 复杂数据JSON存储
    collected_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建时间分区索引
CREATE INDEX idx_collection_data_time ON tb_collection_data (collected_at DESC);
CREATE INDEX idx_collection_data_device ON tb_collection_data (device_id, collected_at DESC);
```

#### 报警相关表
```sql
-- 报警规则表
CREATE TABLE tb_alert_rules (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    device_type_id BIGINT REFERENCES tb_device_types(id),
    metric_name VARCHAR(100),
    condition_type VARCHAR(20), -- GT, LT, EQ等
    threshold_value DECIMAL(20,6),
    level VARCHAR(20), -- CRITICAL, HIGH, MEDIUM, LOW
    enabled BOOLEAN DEFAULT TRUE,
    notification_config JSONB, -- 通知配置
    created_by BIGINT REFERENCES tb_users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 报警记录表
CREATE TABLE tb_alerts (
    id BIGSERIAL PRIMARY KEY,
    rule_id BIGINT REFERENCES tb_alert_rules(id),
    device_id BIGINT REFERENCES tb_devices(id),
    title VARCHAR(200) NOT NULL,
    description TEXT,
    level VARCHAR(20),
    status VARCHAR(20) DEFAULT 'PENDING', -- PENDING, PROCESSING, RESOLVED, IGNORED
    trigger_value DECIMAL(20,6),
    trigger_time TIMESTAMP NOT NULL,
    processed_by BIGINT REFERENCES tb_users(id),
    processed_at TIMESTAMP,
    process_note TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 系统配置相关表
```sql
-- 系统配置表
CREATE TABLE tb_system_settings (
    id BIGSERIAL PRIMARY KEY,
    group_name VARCHAR(50) NOT NULL,
    key_name VARCHAR(100) NOT NULL,
    value TEXT,
    description VARCHAR(200),
    updated_by BIGINT REFERENCES tb_users(id),
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(group_name, key_name)
);

-- 操作日志表
CREATE TABLE tb_operation_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES tb_users(id),
    module VARCHAR(50), -- 模块名称
    operation VARCHAR(100), -- 操作类型
    target_type VARCHAR(50), -- 操作对象类型
    target_id BIGINT, -- 操作对象ID
    details JSONB, -- 操作详情
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 创建索引
CREATE INDEX idx_operation_logs_user ON tb_operation_logs (user_id, created_at DESC);
CREATE INDEX idx_operation_logs_time ON tb_operation_logs (created_at DESC);
```

### 4.2 Redis数据结构设计

#### 缓存Key设计规范
```
# 用户会话
session:user:{userId}
session:token:{token}

# 设备状态缓存
device:status:{deviceId}
device:online:list

# 采集数据缓存（最近数据）
collector:data:{deviceId}:{metricName}
collector:latest:{deviceId}

# 报警缓存
alert:pending:list
alert:stats:count

# 系统配置缓存
config:{groupName}:{keyName}
config:all

# 任务调度缓存
task:schedule:list
task:running:{taskId}

# 实时数据推送
websocket:users:{userId}
```

---

## 5. 核心模块设计

### 5.1 数据采集引擎设计

#### 5.1.1 采集引擎核心接口
```java
// 采集插件接口
public interface CollectorPlugin {
    String getPluginType();
    boolean supports(DeviceType deviceType);
    CollectionResult collect(Device device, MetricConfig config);
    void initialize(CollectorConfig config);
    void destroy();
}

// 采集结果封装
public class CollectionResult {
    private boolean success;
    private Map<String, Object> metrics;
    private String errorMessage;
    private long timestamp;
}

// 采集引擎管理器
@Component
public class CollectorEngine {
    private final Map<String, CollectorPlugin> plugins = new HashMap<>();
    
    public void registerPlugin(CollectorPlugin plugin);
    public CollectionResult executeCollection(CollectionTask task);
    public void scheduleTask(CollectionTask task);
}
```

#### 5.1.2 插件化扩展机制
```java
// SNMP采集插件示例
@Component
public class SnmpCollectorPlugin implements CollectorPlugin {
    @Override
    public String getPluginType() {
        return "SNMP";
    }
    
    @Override
    public CollectionResult collect(Device device, MetricConfig config) {
        // SNMP采集逻辑
        return new CollectionResult();
    }
}

// HTTP采集插件示例
@Component
public class HttpCollectorPlugin implements CollectorPlugin {
    @Override
    public String getPluginType() {
        return "HTTP";
    }
    
    @Override
    public CollectionResult collect(Device device, MetricConfig config) {
        // HTTP API采集逻辑
        return new CollectionResult();
    }
}
```

### 5.2 任务调度设计

#### 5.2.1 调度器核心实现
```java
@Component
public class TaskScheduler {
    
    @Scheduled(fixedDelay = 60000) // 每分钟检查一次
    public void checkAndExecuteTasks() {
        List<CollectionTask> tasks = getScheduledTasks();
        for (CollectionTask task : tasks) {
            if (shouldExecute(task)) {
                executeTaskAsync(task);
            }
        }
    }
    
    @Async
    public void executeTaskAsync(CollectionTask task) {
        // 异步执行采集任务
    }
}
```

### 5.3 实时数据推送设计

#### 5.3.1 WebSocket配置
```java
@Configuration
@EnableWebSocket
public class WebSocketConfig implements WebSocketConfigurer {
    
    @Override
    public void registerWebSocketHandlers(WebSocketHandlerRegistry registry) {
        registry.addHandler(new MonitoringWebSocketHandler(), "/ws/monitoring")
                .setAllowedOrigins("*");
    }
}

@Component
public class MonitoringWebSocketHandler extends TextWebSocketHandler {
    
    @Override
    public void afterConnectionEstablished(WebSocketSession session) {
        // 连接建立后的处理
    }
    
    public void pushDeviceStatus(Long deviceId, DeviceStatus status) {
        // 推送设备状态更新
    }
    
    public void pushAlertMessage(Alert alert) {
        // 推送报警消息
    }
}
```

### 5.4 缓存策略设计

#### 5.4.1 多级缓存架构
```java
@Service
public class DeviceService {
    
    @Cacheable(value = "devices", key = "#deviceId")
    public Device getDeviceById(Long deviceId) {
        return deviceRepository.findById(deviceId).orElse(null);
    }
    
    @CacheEvict(value = "devices", key = "#device.id")
    public Device updateDevice(Device device) {
        return deviceRepository.save(device);
    }
    
    // 设备状态缓存（Redis）
    public void updateDeviceStatus(Long deviceId, DeviceStatus status) {
        redisTemplate.opsForValue().set(
            "device:status:" + deviceId, 
            status, 
            Duration.ofMinutes(5)
        );
    }
}
```

---

## 6. API设计规范

### 6.1 RESTful API设计

#### 6.1.1 URL设计规范
```
# 认证相关
POST   /api/auth/login           # 用户登录
POST   /api/auth/logout          # 用户登出
POST   /api/auth/refresh         # 刷新Token

# 设备管理
GET    /api/devices              # 获取设备列表
POST   /api/devices              # 创建设备
GET    /api/devices/{id}         # 获取设备详情
PUT    /api/devices/{id}         # 更新设备
DELETE /api/devices/{id}         # 删除设备
POST   /api/devices/{id}/test    # 测试设备连接

# 采集器管理
GET    /api/collectors           # 获取采集器列表
POST   /api/collectors           # 创建采集器
GET    /api/collectors/{id}      # 获取采集器详情
PUT    /api/collectors/{id}      # 更新采集器
DELETE /api/collectors/{id}      # 删除采集器

# 任务调度
GET    /api/tasks                # 获取任务列表
POST   /api/tasks                # 创建任务
GET    /api/tasks/{id}           # 获取任务详情
PUT    /api/tasks/{id}           # 更新任务
DELETE /api/tasks/{id}           # 删除任务
POST   /api/tasks/{id}/execute   # 手动执行任务

# 报警管理
GET    /api/alerts               # 获取报警列表
GET    /api/alerts/{id}          # 获取报警详情
PUT    /api/alerts/{id}/process  # 处理报警
```

#### 6.1.2 统一响应格式
```java
@Data
public class ApiResponse<T> {
    private Integer code;
    private String message;
    private T data;
    private Map<String, Object> meta;
    
    public static <T> ApiResponse<T> success(T data) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setCode(200);
        response.setMessage("操作成功");
        response.setData(data);
        return response;
    }
    
    public static <T> ApiResponse<T> error(Integer code, String message) {
        ApiResponse<T> response = new ApiResponse<>();
        response.setCode(code);
        response.setMessage(message);
        return response;
    }
}
```

### 6.2 异常处理设计

```java
@RestControllerAdvice
public class GlobalExceptionHandler {
    
    @ExceptionHandler(BusinessException.class)
    public ApiResponse<Void> handleBusinessException(BusinessException e) {
        return ApiResponse.error(e.getCode(), e.getMessage());
    }
    
    @ExceptionHandler(ValidationException.class)
    public ApiResponse<Void> handleValidationException(ValidationException e) {
        return ApiResponse.error(400, "参数校验失败: " + e.getMessage());
    }
    
    @ExceptionHandler(Exception.class)
    public ApiResponse<Void> handleException(Exception e) {
        log.error("系统异常", e);
        return ApiResponse.error(500, "系统内部错误");
    }
}
```

---

## 7. 安全设计

### 7.1 认证授权机制

#### 7.1.1 JWT配置
```java
@Configuration
@EnableWebSecurity
public class SecurityConfig {
    
    @Bean
    public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
        http.csrf().disable()
            .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)
            .and()
            .authorizeHttpRequests(auth -> auth
                .requestMatchers("/api/auth/**").permitAll()
                .requestMatchers("/api/devices/**").hasRole("USER")
                .requestMatchers("/api/admin/**").hasRole("ADMIN")
                .anyRequest().authenticated()
            )
            .addFilterBefore(jwtAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class);
        
        return http.build();
    }
}
```

#### 7.1.2 权限控制
```java
@Service
public class PermissionService {
    
    public boolean hasPermission(String resource, String action) {
        Authentication auth = SecurityContextHolder.getContext().getAuthentication();
        // 检查用户权限逻辑
        return checkUserPermission(auth.getName(), resource, action);
    }
}

// 方法级权限控制
@PreAuthorize("@permissionService.hasPermission('device', 'delete')")
public void deleteDevice(Long deviceId) {
    // 删除设备逻辑
}
```

### 7.2 数据安全

#### 7.2.1 敏感数据加密
```java
@Component
public class DataEncryption {
    
    @Value("${app.encryption.key}")
    private String encryptionKey;
    
    public String encrypt(String plainText) {
        // AES加密实现
        return encryptedText;
    }
    
    public String decrypt(String encryptedText) {
        // AES解密实现
        return plainText;
    }
}
```

---

## 8. 性能优化策略

### 8.1 数据库优化

#### 8.1.1 索引策略
```sql
-- 常用查询索引
CREATE INDEX idx_devices_status ON tb_devices (status);
CREATE INDEX idx_devices_type_area ON tb_devices (device_type_id, area_id);
CREATE INDEX idx_alerts_status_time ON tb_alerts (status, created_at DESC);
CREATE INDEX idx_collection_data_composite ON tb_collection_data (device_id, metric_name, collected_at DESC);

-- 分区表（历史数据）
CREATE TABLE tb_collection_data_y2024m01 PARTITION OF tb_collection_data
    FOR VALUES FROM ('2024-01-01') TO ('2024-02-01');
```

#### 8.1.2 查询优化
```java
@Repository
public class DeviceRepository extends JpaRepository<Device, Long> {
    
    // 使用原生SQL优化复杂查询
    @Query(value = "SELECT d.*, dt.name as type_name FROM tb_devices d " +
                   "LEFT JOIN tb_device_types dt ON d.device_type_id = dt.id " +
                   "WHERE d.status = :status ORDER BY d.updated_at DESC", 
           nativeQuery = true)
    List<Device> findDevicesByStatusOptimized(@Param("status") Integer status);
}
```

### 8.2 缓存优化

#### 8.2.1 缓存策略
```java
@Configuration
@EnableCaching
public class CacheConfig {
    
    @Bean
    public CacheManager cacheManager() {
        RedisCacheManager.Builder builder = RedisCacheManager
            .RedisCacheManagerBuilder
            .fromConnectionFactory(redisConnectionFactory())
            .cacheDefaults(cacheConfiguration());
        
        return builder.build();
    }
    
    private RedisCacheConfiguration cacheConfiguration() {
        return RedisCacheConfiguration.defaultCacheConfig()
            .entryTtl(Duration.ofMinutes(10))
            .serializeKeysWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new StringRedisSerializer()))
            .serializeValuesWith(RedisSerializationContext.SerializationPair
                .fromSerializer(new GenericJackson2JsonRedisSerializer()));
    }
}
```

### 8.3 异步处理

#### 8.3.1 异步任务配置
```java
@Configuration
@EnableAsync
public class AsyncConfig {
    
    @Bean
    public TaskExecutor taskExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();
        executor.setCorePoolSize(10);
        executor.setMaxPoolSize(50);
        executor.setQueueCapacity(100);
        executor.setThreadNamePrefix("SkyEye-Async-");
        executor.initialize();
        return executor;
    }
}
```

---

## 9. 监控与运维

### 9.1 应用监控

#### 9.1.1 健康检查
```java
@Component
public class CustomHealthIndicator implements HealthIndicator {
    
    @Override
    public Health health() {
        // 检查数据库连接
        // 检查Redis连接
        // 检查关键服务状态
        
        return Health.up()
            .withDetail("database", "UP")
            .withDetail("redis", "UP")
            .withDetail("collector", "UP")
            .build();
    }
}
```

#### 9.1.2 性能指标
```java
@Component
public class MetricsCollector {
    
    private final MeterRegistry meterRegistry;
    
    @EventListener
    public void handleDeviceStatusChange(DeviceStatusChangeEvent event) {
        // 记录设备状态变化指标
        meterRegistry.counter("device.status.change", 
            "type", event.getDeviceType(),
            "status", event.getNewStatus().name())
            .increment();
    }
}
```

### 9.2 日志管理

#### 9.2.1 日志配置
```xml
<!-- logback-spring.xml -->
<configuration>
    <springProfile name="!prod">
        <appender name="CONSOLE" class="ch.qos.logback.core.ConsoleAppender">
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="CONSOLE"/>
        </root>
    </springProfile>
    
    <springProfile name="prod">
        <appender name="FILE" class="ch.qos.logback.core.rolling.RollingFileAppender">
            <file>logs/skyeye.log</file>
            <rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy">
                <fileNamePattern>logs/skyeye.%d{yyyy-MM-dd}.%i.log</fileNamePattern>
                <maxFileSize>100MB</maxFileSize>
                <maxHistory>30</maxHistory>
            </rollingPolicy>
            <encoder>
                <pattern>%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n</pattern>
            </encoder>
        </appender>
        <root level="INFO">
            <appender-ref ref="FILE"/>
        </root>
    </springProfile>
</configuration>
```

---

## 10. 部署方案

### 10.1 Docker化部署

#### 10.1.1 Dockerfile
```dockerfile
FROM openjdk:17-jdk-slim

WORKDIR /app

COPY target/skyeye-*.jar app.jar

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "app.jar"]
```

#### 10.1.2 Docker Compose
```yaml
version: '3.8'

services:
  skyeye-app:
    build: .
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=prod
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres:5432/skyeye
      - SPRING_REDIS_HOST=redis
    depends_on:
      - postgres
      - redis

  postgres:
    image: postgres:15
    environment:
      POSTGRES_DB: skyeye
      POSTGRES_USER: skyeye
      POSTGRES_PASSWORD: skyeye123
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./dist:/usr/share/nginx/html
    depends_on:
      - skyeye-app

volumes:
  postgres_data:
  redis_data:
```

### 10.2 配置管理

#### 10.2.1 应用配置
```yaml
# application.yml
spring:
  application:
    name: skyeye-monitoring
  
  datasource:
    url: jdbc:postgresql://localhost:5432/skyeye
    username: ${DB_USERNAME:skyeye}
    password: ${DB_PASSWORD:skyeye123}
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        format_sql: true
        
  redis:
    host: ${REDIS_HOST:localhost}
    port: ${REDIS_PORT:6379}
    password: ${REDIS_PASSWORD:}
    timeout: 2000ms
    lettuce:
      pool:
        max-active: 8
        max-idle: 8
        min-idle: 0

  security:
    jwt:
      secret: ${JWT_SECRET:skyeye-jwt-secret-key-2024}
      expiration: 86400000 # 24小时

# 应用自定义配置
app:
  collector:
    thread-pool-size: 20
    max-retry-times: 3
  
  file:
    upload-path: ${FILE_UPLOAD_PATH:/app/uploads}
    max-size: 10MB
    
  websocket:
    max-connections: 1000

# 监控配置
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics
  endpoint:
    health:
      show-details: when-authorized

# 日志配置
logging:
  level:
    com.skyeye: INFO
    org.springframework.security: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

---

## 11. 开发规范

### 11.1 代码规范

#### 11.1.1 命名规范
- **类名**：使用大驼峰命名法，如 `DeviceService`
- **方法名**：使用小驼峰命名法，如 `getDeviceById`
- **变量名**：使用小驼峰命名法，如 `deviceList`
- **常量名**：使用大写字母和下划线，如 `MAX_RETRY_TIMES`
- **包名**：使用小写字母，如 `com.skyeye.device`

#### 11.1.2 注释规范
```java
/**
 * 设备管理服务
 * 
 * @author SkyEye Team
 * @version 1.0
 * @since 2024-01-01
 */
@Service
@Transactional
public class DeviceService {
    
    /**
     * 根据ID获取设备信息
     * 
     * @param deviceId 设备ID
     * @return 设备信息，如果不存在返回null
     * @throws IllegalArgumentException 当deviceId为null时抛出
     */
    public Device getDeviceById(Long deviceId) {
        if (deviceId == null) {
            throw new IllegalArgumentException("设备ID不能为空");
        }
        return deviceRepository.findById(deviceId).orElse(null);
    }
}
```

### 11.2 测试规范

#### 11.2.1 单元测试
```java
@ExtendWith(MockitoExtension.class)
class DeviceServiceTest {
    
    @Mock
    private DeviceRepository deviceRepository;
    
    @InjectMocks
    private DeviceService deviceService;
    
    @Test
    void testGetDeviceById_Success() {
        // Given
        Long deviceId = 1L;
        Device expectedDevice = new Device();
        expectedDevice.setId(deviceId);
        when(deviceRepository.findById(deviceId)).thenReturn(Optional.of(expectedDevice));
        
        // When
        Device result = deviceService.getDeviceById(deviceId);
        
        // Then
        assertThat(result).isNotNull();
        assertThat(result.getId()).isEqualTo(deviceId);
    }
    
    @Test
    void testGetDeviceById_NotFound() {
        // Given
        Long deviceId = 999L;
        when(deviceRepository.findById(deviceId)).thenReturn(Optional.empty());
        
        // When
        Device result = deviceService.getDeviceById(deviceId);
        
        // Then
        assertThat(result).isNull();
    }
}
```

---

## 12. 总结

### 12.1 架构优势
1. **简单实用**：采用Spring Boot单体架构，避免微服务复杂性
2. **扩展性强**：插件化的采集引擎设计，支持多种设备类型
3. **性能优化**：多级缓存、异步处理、数据库优化
4. **安全可靠**：完善的认证授权、数据加密、异常处理
5. **运维友好**：Docker化部署、健康检查、日志监控

### 12.2 技术选型理由
- **PostgreSQL**：强大的JSON支持，适合设备配置存储
- **Redis**：高性能缓存，支持多种数据结构
- **Spring Boot**：成熟的Java框架，开发效率高
- **JWT**：无状态认证，支持分布式部署

### 12.3 实施建议
1. **分阶段实施**：按功能优先级分阶段开发
2. **数据迁移**：制定详细的数据迁移方案
3. **性能测试**：在生产环境部署前进行充分的性能测试
4. **监控告警**：建立完善的监控告警机制
5. **文档维护**：保持技术文档和API文档的及时更新

该架构设计充分考虑了功能需求、性能要求和扩展性，为SkyEye智能监控系统提供了坚实的技术基础。 