# 数据库字段类型修复说明

## 问题描述

在添加设备时出现以下错误：

```
ERROR: column "ip_address" is of type inet but expression is of type character varying
建议：You need to rewrite or cast the expression.
```

## 问题原因

PostgreSQL数据库中的`tb_devices`表使用了特殊的网络类型：
- `ip_address` 字段类型为 `INET`（网络地址类型）
- `mac_address` 字段类型为 `MACADDR`（MAC地址类型）

而Java代码中这些字段的类型是`String`，Hibernate无法自动处理这种类型转换。

## 解决方案

### 方案1：修改数据库表结构（推荐）

将网络字段类型改为标准的`VARCHAR`类型，这样既保持了数据完整性，又避免了类型转换问题。

**执行步骤：**

1. 运行数据库迁移脚本：
```sql
-- 修复设备表网络字段类型
ALTER TABLE tb_devices 
ALTER COLUMN ip_address TYPE VARCHAR(45);

ALTER TABLE tb_devices 
ALTER COLUMN mac_address TYPE VARCHAR(17);
```

2. 验证修改：
```sql
SELECT column_name, data_type, character_maximum_length 
FROM information_schema.columns 
WHERE table_name = 'tb_devices' 
AND column_name IN ('ip_address', 'mac_address');
```

### 方案2：使用自定义类型转换器

如果必须保持`INET`和`MACADDR`类型，可以创建Hibernate自定义类型转换器。

**优点：**
- 保持PostgreSQL特有的网络类型
- 可以利用PostgreSQL的网络类型验证功能

**缺点：**
- 增加代码复杂度
- 可能影响查询性能
- 需要额外的类型转换逻辑

## 已完成的修复

1. ✅ 创建了数据库迁移脚本 `V1.0.8__fix_device_network_fields.sql`
2. ✅ 更新了Device实体类，移除了特殊的列定义
3. ✅ 更新了DeviceRepository，移除了原生SQL查询
4. ✅ 恢复了IP地址和MAC地址的唯一性检查

## 字段长度说明

- `ip_address`: VARCHAR(45) - 支持IPv6地址的最大长度
- `mac_address`: VARCHAR(17) - 支持标准MAC地址格式 (XX:XX:XX:XX:XX:XX)

## 应用修复

### 方法1：手动执行SQL（开发环境）

```bash
# 连接到PostgreSQL数据库
psql -h localhost -U your_username -d your_database

# 执行修复脚本
\i V1.0.8__fix_device_network_fields.sql
```

### 方法2：通过应用程序自动执行

如果使用Flyway或Liquibase等数据库迁移工具，将迁移脚本放在相应目录中，应用启动时会自动执行。

## 验证修复

1. 重启应用程序
2. 尝试添加新设备
3. 检查是否还有类型转换错误
4. 验证IP地址和MAC地址的唯一性检查是否正常工作

## 注意事项

1. **数据备份**：在生产环境执行前，请先备份数据库
2. **停机时间**：修改表结构可能需要短暂的停机时间
3. **数据验证**：确保现有数据在类型转换后仍然有效
4. **应用重启**：修改完成后需要重启应用程序

## 后续优化建议

1. 在前端添加IP地址格式验证
2. 在前端添加MAC地址格式验证
3. 考虑添加网络地址的正则表达式验证
4. 可以添加网络地址的合法性检查（如IP地址范围验证）
